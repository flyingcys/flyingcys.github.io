<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">TuyaOpen串口工具(内测版)</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Chrome浏览器要求提醒 -->
        <div class="browser-warning" id="browserWarning" style="display: none;">
            <div class="warning-content">
                <span class="warning-icon">⚠️</span>
                <span class="warning-text" data-i18n="browser_requirement">此工具需要Chrome内核浏览器支持，其他浏览器无法正常工作。请使用Chrome、Edge或其他基于Chromium的浏览器。</span>
                <button class="warning-close" onclick="document.getElementById('browserWarning').style.display='none'">✕</button>
            </div>
        </div>

        <header>
            <div class="header-top">
                <div class="language-switcher">
                    <div class="lang-dropdown" id="langDropdown">
                        <button class="lang-dropdown-btn" id="langDropdownBtn" title="切换语言 / Switch Language">
                            <span class="lang-flag" id="currentLangFlag">🇨🇳</span>
                            <span class="lang-name" id="currentLangName">简体中文</span>
                            <span class="dropdown-arrow">▼</span>
                        </button>
                        <div class="lang-dropdown-menu" id="langDropdownMenu">
                            <div class="lang-option" data-lang="zh">
                                <span class="lang-flag">🇨🇳</span>
                                <span class="lang-name">简体中文</span>
                            </div>
                            <div class="lang-option" data-lang="zh-tw">
                                <span class="lang-flag">🇹🇼</span>
                                <span class="lang-name">繁體中文</span>
                            </div>
                            <div class="lang-option" data-lang="en">
                                <span class="lang-flag">🇺🇸</span>
                                <span class="lang-name">English</span>
                            </div>
                            <div class="lang-option" data-lang="fr">
                                <span class="lang-flag">🇫🇷</span>
                                <span class="lang-name">Français</span>
                            </div>
                            <div class="lang-option" data-lang="de">
                                <span class="lang-flag">🇩🇪</span>
                                <span class="lang-name">Deutsch</span>
                            </div>
                            <div class="lang-option" data-lang="es">
                                <span class="lang-flag">🇪🇸</span>
                                <span class="lang-name">Español</span>
                            </div>
                            <div class="lang-option" data-lang="ja">
                                <span class="lang-flag">🇯🇵</span>
                                <span class="lang-name">日本語</span>
                            </div>
                            <div class="lang-option" data-lang="ko">
                                <span class="lang-flag">🇰🇷</span>
                                <span class="lang-name">한국어</span>
                            </div>
                            <div class="lang-option" data-lang="ru">
                                <span class="lang-flag">🇷🇺</span>
                                <span class="lang-name">Русский</span>
                            </div>
                            <div class="lang-option" data-lang="pt">
                                <span class="lang-flag">🇵🇹</span>
                                <span class="lang-name">Português</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <h1 data-i18n="title">TuyaOpen串口工具(内测版)</h1>
            <p data-i18n="subtitle">基于Chrome Web Serial API的一站式开发者工具</p>
        </header>

        <!-- Tab导航 -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="serial" data-i18n="tab_serial">📡 串口调试</button>
            <button class="tab-btn" data-tab="flash" data-i18n="tab_flash">💾 固件下载</button>
        </div>

        <!-- Tab内容区域 -->
        <div class="tab-content">
            <!-- 串口调试Tab -->
            <div id="serialTab" class="tab-panel active">
                <!-- 串口调试控制面板 -->
                <div class="control-panel">
                    <div class="control-header">
                        <h3 data-i18n="control_title">🔧 串口连接控制</h3>
                        <div class="control-header-right" id="serialTargetDeviceContainer">
                            <div class="config-group">
                                <label for="serialTargetDevice" data-i18n="serial_target_device">目标设备:</label>
                                <select id="serialTargetDevice">
                                    <option value="custom" selected data-i18n="custom_device">自定义</option>
                                    <option value="T5AI">T5AI</option>
                                    <option value="T3">T3</option>
                                    <option value="T2">T2</option>
                                    <option value="ESP32">ESP32</option>
                                    <option value="ESP32C3">ESP32-C3</option>
                                    <option value="ESP32S3">ESP32-S3</option>
                                    <option value="BK7231N">BK7231N</option>
                                    <option value="LN882H">LN882H</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="connection-controls">
                        <button id="connectBtn" class="btn btn-primary">
                            <span class="icon">🔗</span>
                            <span data-i18n="connect">连接串口</span>
                        </button>
                        <button id="disconnectBtn" class="btn btn-secondary" disabled>
                            <span class="icon"></span>
                            <span data-i18n="disconnect">断开连接</span>
                        </button>
                        <div class="status-indicator">
                            <span class="status-dot" id="statusDot"></span>
                            <span id="statusText" data-i18n="status_disconnected">未连接</span>
                        </div>
                    </div>

                    <div class="serial-config">
                        <div class="config-group">
                            <label for="baudRate" data-i18n="baud_rate">波特率:</label>
                            <select id="baudRate">
                                <option value="9600">9600</option>
                                <option value="19200">19200</option>
                                <option value="38400">38400</option>
                                <option value="57600">57600</option>
                                <option value="115200" selected>115200</option>
                                <option value="230400">230400</option>
                                <option value="460800">460800</option>
                                <option value="921600">921600</option>
                                <option value="1500000">1500000</option>
                                <option value="2000000">2000000</option>
                                <option value="3000000">3000000</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="dataBits" data-i18n="data_bits">数据位:</label>
                            <select id="dataBits">
                                <option value="7">7</option>
                                <option value="8" selected>8</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="stopBits" data-i18n="stop_bits">停止位:</label>
                            <select id="stopBits">
                                <option value="1" selected>1</option>
                                <option value="2">2</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="parity" data-i18n="parity">校验位:</label>
                            <select id="parity">
                                <option value="none" selected data-i18n="parity_none">无</option>
                                <option value="even" data-i18n="parity_even">偶校验</option>
                                <option value="odd" data-i18n="parity_odd">奇校验</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 数据接收显示区域 -->
                <div class="receive-data-panel">
                    <div class="data-header">
                        <h3 data-i18n="receive_data">📨 接收数据</h3>
                        <div class="data-controls">
                            <div class="data-controls-left">
                                <button id="clearBtn" class="btn btn-small" data-i18n="clear_log">清空日志</button>
                                <button id="saveBtn" class="btn btn-small" data-i18n="save_log">保存日志</button>
                                <label class="checkbox-container">
                                    <input type="checkbox" id="showTimestamp" checked>
                                    <span class="checkmark"></span>
                                    <span data-i18n="show_timestamp">显示时间戳</span>
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" id="autoScroll" checked>
                                    <span class="checkmark"></span>
                                    <span data-i18n="auto_scroll">自动滚动</span>
                                </label>
                            </div>
                            <div class="data-controls-right">
                                <button id="fullscreenBtn" class="btn btn-small btn-fullscreen" data-i18n-title="fullscreen">
                                    <span class="icon">⛶</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="data-display" id="dataDisplay">
                        <div class="placeholder" data-i18n="waiting_data">等待串口数据...</div>
                    </div>
                    <div class="data-stats">
                        <span><span data-i18n="received">接收</span>: <span id="rxCount">0</span> <span data-i18n="bytes">字节</span></span>
                        <span><span data-i18n="sent">发送</span>: <span id="txCount">0</span> <span data-i18n="bytes">字节</span></span>
                    </div>
                </div>

                <!-- 数据发送区域 -->
                <div class="send-data-panel">
                    <div class="send-header">
                        <h3 data-i18n="send_data">📤 发送数据</h3>
                        <div class="send-options">
                            <label class="checkbox-container">
                                <input type="checkbox" id="hexMode">
                                <span class="checkmark"></span>
                                <span data-i18n="hex_mode">十六进制模式</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" id="addNewline" checked>
                                <span class="checkmark"></span>
                                <span data-i18n="add_newline">自动换行</span>
                            </label>
                        </div>
                    </div>
                    <div class="send-controls">
                        <input type="text" id="sendInput" data-i18n-placeholder="input_placeholder" placeholder="输入要发送的数据...">
                        <button id="sendBtn" class="btn btn-primary" disabled>
                            <span class="icon">📤</span>
                            <span data-i18n="send">发送</span>
                        </button>
                    </div>
                    <div class="send-tip">
                        <span data-i18n="send_tip">💡 提示：按 Ctrl+Enter 快速发送</span>
                    </div>
                </div>

                <!-- 快捷发送按钮区域 -->
                <div class="quick-commands-panel">
                    <div class="quick-header">
                        <h3 data-i18n="quick_commands">⚡ 快捷发送</h3>
                        <button id="manageQuickBtn" class="btn btn-small" data-i18n="manage_commands">管理命令</button>
                    </div>
                    <div class="quick-buttons" id="quickButtons">
                        <!-- 快捷按钮将通过JavaScript动态生成 -->
                    </div>
                    <div class="no-quick-commands" id="noQuickCommands" style="display: none;">
                        <p data-i18n="no_quick_commands">暂无快捷命令，点击"管理命令"添加</p>
                    </div>
                </div>
            </div>

            <!-- 固件下载Tab -->
            <div id="flashTab" class="tab-panel">
                <!-- 固件下载控制面板 -->
                <div class="control-panel">
                    <div class="control-header">
                        <h3 data-i18n="flash_control_title">🔧 固件下载控制</h3>
                        <div class="debug-control">
                            <label class="checkbox-container">
                                <input type="checkbox" id="flashDebugMode">
                                <span class="checkmark"></span>
                                <span data-i18n="debug_mode">调试模式</span>
                            </label>
                            <div class="debug-status-bar" id="debugStatusBar">
                                <span data-i18n="debug_status">状态:</span>
                                <span class="debug-status-value" id="debugStatusValue" data-i18n="disabled">禁用</span>
                            </div>
                        </div>
                    </div>
                    <div class="connection-controls">
                        <button id="connectFlashBtn" class="btn btn-primary">
                            <span class="icon">🔗</span>
                            <span data-i18n="connect_flash">连接串口</span>
                        </button>
                        <button id="disconnectFlashBtn" class="btn btn-secondary" disabled>
                            <span class="icon"></span>
                            <span data-i18n="disconnect">断开连接</span>
                        </button>
                        <div class="status-indicator">
                            <span class="status-dot" id="flashStatusDot"></span>
                            <span id="flashStatusText" data-i18n="status_disconnected">未连接</span>
                        </div>
                    </div>

                    <div class="serial-config">
                        <div class="config-group">
                            <label for="flashBaudRate" data-i18n="baud_rate">波特率:</label>
                            <select id="flashBaudRate">
                                <option value="9600">9600</option>
                                <option value="19200">19200</option>
                                <option value="38400">38400</option>
                                <option value="57600">57600</option>
                                <option value="115200" selected>115200</option>
                                <option value="230400">230400</option>
                                <option value="460800">460800</option>
                                <option value="921600">921600</option>
                                <option value="1500000">1500000</option>
                                <option value="2000000">2000000</option>
                                <option value="3000000">3000000</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="flashDataBits" data-i18n="data_bits">数据位:</label>
                            <select id="flashDataBits">
                                <option value="7">7</option>
                                <option value="8" selected>8</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="flashStopBits" data-i18n="stop_bits">停止位:</label>
                            <select id="flashStopBits">
                                <option value="1" selected>1</option>
                                <option value="2">2</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="flashParity" data-i18n="parity">校验位:</label>
                            <select id="flashParity">
                                <option value="none" selected data-i18n="parity_none">无</option>
                                <option value="even" data-i18n="parity_even">偶校验</option>
                                <option value="odd" data-i18n="parity_odd">奇校验</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 文件选择面板 -->
                <div class="file-selection-panel">
                    <div class="file-header">
                        <h3 data-i18n="file_selection">📁 文件选择</h3>
                    </div>
                    <div class="file-controls">
                        <button id="selectFileBtn" class="btn btn-primary">
                            <span class="icon">📁</span>
                            <span data-i18n="select_file">选择文件</span>
                        </button>
                        <input type="file" id="binFileInput" accept=".bin" style="display: none;">
                        <div class="file-info" id="fileInfo" style="display: none;">
                            <div class="file-name">
                                <span data-i18n="selected_file">已选择文件:</span>
                                <span id="selectedFileName" data-i18n="no_file_selected">未选择文件</span>
                            </div>
                            <div class="file-size">
                                <span data-i18n="file_size">文件大小:</span>
                                <span id="fileSize">0</span>
                                <span data-i18n="bytes">字节</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 设备选择和下载面板 -->
                <div class="device-download-panel">
                    <div class="device-header">
                        <h3 data-i18n="device_download">💾 设备下载</h3>
                    </div>
                    <div class="device-controls">
                        <div class="config-group">
                            <label for="deviceSelect" data-i18n="target_device">目标设备:</label>
                            <select id="deviceSelect">
                                <option value="T5AI">T5AI</option>
                            </select>
                        </div>
                        <div class="download-buttons">
                            <button id="downloadBtn" class="btn btn-success" disabled>
                                <span class="icon">⬇️</span>
                                <span data-i18n="start_download">开始下载</span>
                            </button>
                            <button id="stopDownloadBtn" class="btn btn-danger" disabled>
                                <span class="icon">⏹️</span>
                                <span data-i18n="stop_download">停止下载</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 下载进度面板 -->
                <div class="progress-panel" id="progressArea" style="display: none;">
                    <div class="progress-header">
                        <h3 data-i18n="download_progress">📊 下载进度</h3>
                    </div>
                    <div class="progress-content">
                        <div class="progress-text" id="progressText" data-i18n="preparing_download">准备下载...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                            <div class="progress-percent" id="progressPercent">0%</div>
                        </div>
                        <div class="progress-stats">
                            <span><span data-i18n="downloaded">已下载</span>: <span id="downloadedBytes">0</span> / <span id="totalBytes">0</span> <span data-i18n="bytes">字节</span></span>
                            <span><span data-i18n="speed">速度</span>: <span id="downloadSpeed">0</span> <span data-i18n="bps">字节/秒</span></span>
                        </div>
                    </div>
                </div>

                <!-- 下载日志面板 -->
                <div class="flash-log-panel">
                    <div class="log-header">
                        <h3 data-i18n="download_log">📋 下载日志</h3>
                        <div class="log-controls">
                            <div class="log-controls-left">
                                <button id="clearFlashLogBtn" class="btn btn-small" data-i18n="clear_log">清空日志</button>
                                <button id="saveFlashLogBtn" class="btn btn-small" data-i18n="save_log">保存日志</button>
                                <label class="checkbox-container">
                                    <input type="checkbox" id="flashAutoScroll" checked>
                                    <span class="checkmark"></span>
                                    <span data-i18n="auto_scroll">自动滚动</span>
                                </label>
                            </div>
                            <div class="log-controls-right">
                                <button id="flashFullscreenBtn" class="btn btn-small btn-fullscreen" data-i18n-title="fullscreen">
                                    <span class="icon">⛶</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flash-log-display" id="flashLogDisplay">
                        <div class="placeholder" data-i18n="waiting_download">等待下载操作...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 全屏显示覆盖层 -->
    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <div class="fullscreen-content">
            <div class="fullscreen-header">
                <h3 data-i18n="serial_data_fullscreen">串口数据 - 全屏模式</h3>
                <button id="fullscreenCloseBtn" class="btn btn-small">
                    <span class="icon">✕</span>
                    <span data-i18n="close">关闭</span>
                </button>
            </div>
            <div class="fullscreen-data-display" id="fullscreenDataDisplay">
                <div class="placeholder" data-i18n="waiting_data">等待串口数据...</div>
            </div>
        </div>
    </div>

    <!-- 下载日志全屏显示覆盖层 -->
    <div class="fullscreen-overlay" id="flashFullscreenOverlay">
        <div class="fullscreen-content">
            <div class="fullscreen-header">
                <h3 data-i18n="download_log_fullscreen">下载日志 - 全屏模式</h3>
                <button id="flashFullscreenCloseBtn" class="btn btn-small">
                    <span class="icon">✕</span>
                    <span data-i18n="close">关闭</span>
                </button>
            </div>
            <div class="fullscreen-data-display" id="flashFullscreenDataDisplay">
                <div class="placeholder" data-i18n="waiting_download">等待下载操作...</div>
            </div>
        </div>
    </div>

    <!-- 错误提示模态框 -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 data-i18n="error_title">❌ 错误</h3>
            <p id="errorMessage"></p>
        </div>
    </div>

    <!-- 快捷命令管理模态框 -->
    <div id="quickCommandModal" class="modal">
        <div class="modal-content quick-command-modal">
            <span class="close">&times;</span>
            <h3 data-i18n="manage_quick_commands">⚡ 管理快捷命令</h3>
            
            <div class="quick-command-form">
                <div class="form-group">
                    <label for="commandName" data-i18n="command_name">命令名称:</label>
                    <input type="text" id="commandName" data-i18n-placeholder="command_name_placeholder" placeholder="输入命令名称..." maxlength="20">
                </div>
                <div class="form-group">
                    <label for="commandValue" data-i18n="command_value">命令内容:</label>
                    <input type="text" id="commandValue" data-i18n-placeholder="command_value_placeholder" placeholder="输入命令内容...">
                </div>
                <div class="form-actions">
                    <button id="addCommandBtn" class="btn btn-primary" data-i18n="add_command">添加命令</button>
                    <button id="resetDefaultBtn" class="btn btn-secondary" data-i18n="reset_default">重置默认</button>
                </div>
            </div>

            <div class="command-list-container">
                <h4 data-i18n="existing_commands">现有命令</h4>
                <div class="command-list" id="commandList">
                    <!-- 命令列表将通过JavaScript动态生成 -->
                </div>
                <div class="no-commands" id="noCommands" style="display: none;">
                    <p data-i18n="no_commands">暂无命令</p>
                </div>
            </div>

            <div class="modal-actions">
                <button id="closeQuickModalBtn" class="btn btn-secondary" data-i18n="close">关闭</button>
            </div>
        </div>
    </div>

    <!-- 脚本加载 - 关键：按正确顺序加载 -->
    <!-- 1. 多语言系统 -->
    <script src="i18n/languages.js"></script>
    <script src="i18n/en.js"></script>
    <script src="i18n/zh.js"></script>
    <script src="i18n/zh-tw.js"></script>
    <script src="i18n/fr.js"></script>
    <script src="i18n/de.js"></script>
    <script src="i18n/es.js"></script>
    <script src="i18n/ja.js"></script>
    <script src="i18n/ko.js"></script>
    <script src="i18n/ru.js"></script>
    <script src="i18n/pt.js"></script>
    <script src="i18n/i18n.js"></script>
    
    <!-- 2. 固件下载相关脚本 -->
    <script src="chip-downloaders.js"></script>
    <script src="flash-downloader.js"></script>
    
    <!-- 3. 分割后的脚本（按依赖顺序加载）-->
    <script src="script-config.js"></script>  <!-- 配置常量 -->
    <script src="script-utils.js"></script>   <!-- 工具函数 -->
    <script src="script-main.js"></script>    <!-- 主类 -->

    <!-- 4. 应用初始化 -->
    <script>
        // 等待DOM加载完成和多语言系统就绪后初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            // 确保多语言系统先初始化
            i18n.init().then(() => {
                // 创建应用实例
                window.serialTerminal = new SerialTerminal();
                console.log('🚀 分割版本的串口工具已初始化');
            }).catch(error => {
                console.error('多语言系统初始化失败:', error);
                // 即使多语言初始化失败，也要启动应用
                window.serialTerminal = new SerialTerminal();
            });
        });
    </script>
</body>
</html> 