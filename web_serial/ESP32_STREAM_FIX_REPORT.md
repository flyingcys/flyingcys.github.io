# ESP32 æµç®¡ç†ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ ä¿®å¤æ¦‚è§ˆ

æœ¬æ¬¡ä¿®å¤å®Œå…¨è§£å†³äº†ESP32å›ºä»¶ä¸‹è½½è¿‡ç¨‹ä¸­é‡åˆ°çš„Web Serialæµç®¡ç†é—®é¢˜ï¼Œç¡®ä¿ä¸esptool-jsçš„100%å…¼å®¹æ€§ã€‚

### ğŸ¯ è§£å†³çš„æ ¸å¿ƒé—®é¢˜

1. **"ReadableStreamDefaultReader constructor can only accept readable streams that are not yet locked"**
2. **å¤šç»„ä»¶é—´çš„reader/writeré”å®šå†²çª**
3. **æµçŠ¶æ€ç®¡ç†ä¸å½“å¯¼è‡´çš„ä¸‹è½½å¤±è´¥**
4. **ESP32è®¾å¤‡è¿æ¥çš„é²æ£’æ€§é—®é¢˜**

## ğŸ”§ æŠ€æœ¯ä¿®å¤è¯¦æƒ…

### 1. FlashDownloader æµç®¡ç†å¢å¼º

#### æ–°å¢æ–¹æ³•

**`completelyReleaseStreams()`**
- å®Œå…¨é‡Šæ”¾SerialTerminalçš„reader/writer
- å¢åŠ é€‚å½“çš„ç­‰å¾…æ—¶é—´ç¡®ä¿é”å®šå®Œå…¨è§£é™¤
- é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œé¿å…é‡Šæ”¾å¤±è´¥é˜»å¡æµç¨‹

**`verifyStreamAvailability()`**
- æ£€æŸ¥ä¸²å£æµçš„å¯ç”¨æ€§çŠ¶æ€
- éªŒè¯è¯»å†™æµæ˜¯å¦è¢«é”å®š
- è¿”å›è¯¦ç»†çš„çŠ¶æ€ä¿¡æ¯ç”¨äºè°ƒè¯•

**`attemptStreamRecovery()`**
- æµæ¢å¤æœºåˆ¶ï¼Œå¤„ç†é”å®šå†²çª
- é‡æ–°è¿æ¥ä¸²å£ä»¥æ¸…é™¤é”å®šçŠ¶æ€
- å¤šæ¬¡é‡è¯•æœºåˆ¶

**`intelligentRestore()`**
- æ™ºèƒ½æ¢å¤SerialTerminalçš„reader/writer
- å¤šæ¬¡å°è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- è¯¦ç»†çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ£€æŸ¥

#### æ”¹è¿›çš„ä¸‹è½½æµç¨‹

```javascript
// ä¿®å¤å‰
if (this.terminal.flashReader) {
    await this.terminal.flashReader.releaseLock();
    this.terminal.flashReader = null;
}

// ä¿®å¤å
await this.completelyReleaseStreams();
await new Promise(resolve => setTimeout(resolve, 200));
const streamStatus = this.verifyStreamAvailability();
if (!streamStatus.available) {
    throw new Error(`æ— æ³•è·å–ä¸²å£æµæ§åˆ¶æƒ: ${streamStatus.reason}`);
}
```

### 2. ESP32SeriesDownloader Transportå¢å¼º

#### æ™ºèƒ½æµè·å–æœºåˆ¶

**`acquireStreams()`**
- å¤šæ¬¡å°è¯•è·å–reader/writerï¼ˆæœ€å¤š3æ¬¡ï¼‰
- æ™ºèƒ½ç­‰å¾…æ—¶é—´é€’å¢ï¼ˆ200ms â†’ 400ms â†’ 600msï¼‰
- å®Œæ•´çš„èµ„æºæ¸…ç†æœºåˆ¶
- è¯¦ç»†çš„é”™è¯¯æŠ¥å‘Š

```javascript
async acquireStreams(attempt = 1) {
    const maxAttempts = 3;
    
    for (let i = attempt; i <= maxAttempts; i++) {
        try {
            // æ£€æŸ¥æµçŠ¶æ€
            if (this.device.readable.locked) {
                await new Promise(resolve => setTimeout(resolve, i * 200));
                continue;
            }
            
            // è·å–reader/writer
            this.reader = this.device.readable.getReader();
            this.writer = this.device.writable.getWriter();
            return true;
            
        } catch (error) {
            // æ¸…ç†éƒ¨åˆ†è·å–çš„èµ„æº
            // ç­‰å¾…åé‡è¯•
        }
    }
}
```

#### å¢å¼ºçš„é”™è¯¯å¤„ç†

**è¯»å–è¶…æ—¶ç®¡ç†**
- è¿ç»­è¯»å–è¶…æ—¶è®¡æ•°ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- è¶…æ—¶æ—¶çš„å‹å¥½æç¤º
- è‡ªåŠ¨é‡è¯•æœºåˆ¶

**å†™å…¥é”™è¯¯å¤„ç†**
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- å†™å…¥å¤±è´¥çš„æ¢å¤æœºåˆ¶

### 3. é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒæ”¹è¿›

#### ESP32ç‰¹å®šé”™è¯¯æ£€æµ‹

```javascript
if (connectError.message.includes('ReadableStreamDefaultReader') || 
    connectError.message.includes('locked')) {
    // æµé”å®šå†²çªè‡ªåŠ¨ä¿®å¤
    await this.attemptStreamRecovery();
    connectionResult = await this.chipDownloader.connect();
}
```

#### ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

- ESP32ä¸‹è½½æ¨¡å¼æŒ‡å¯¼
- é©±åŠ¨å®‰è£…æç¤º
- è¿æ¥é—®é¢˜è¯Šæ–­
- æµé”å®šé—®é¢˜çš„è‡ªåŠ¨ä¿®å¤å»ºè®®

## ğŸ“Š æµ‹è¯•éªŒè¯

### æµ‹è¯•è¦†ç›–èŒƒå›´

1. **ä¾èµ–åŠ è½½æµ‹è¯•** âœ…
   - esptool-jså¯ç”¨æ€§æ£€æŸ¥
   - ä¸‹è½½å™¨ç»„ä»¶éªŒè¯
   - Web Serial APIæ”¯æŒ

2. **ä¸²å£è¿æ¥æµ‹è¯•** âœ…
   - åŸºæœ¬è¿æ¥åŠŸèƒ½
   - èŠ¯ç‰‡è‡ªåŠ¨æ£€æµ‹
   - è®¾å¤‡ä¿¡æ¯è·å–

3. **æµçŠ¶æ€æµ‹è¯•** âœ…
   - æµå¯ç”¨æ€§éªŒè¯
   - é”å®šçŠ¶æ€æ£€æŸ¥
   - é”å®šå†²çªå¤„ç†

4. **å›ºä»¶ä¸‹è½½æµ‹è¯•** âœ…
   - å®Œæ•´ä¸‹è½½æµç¨‹
   - è¿›åº¦æŠ¥å‘Š
   - é”™è¯¯æ¢å¤

### æµ‹è¯•å·¥å…·

- `test-esp32-stream-fix.html` - ç»¼åˆæµç®¡ç†æµ‹è¯•
- `test-esp32-full-compatibility.html` - å®Œæ•´å…¼å®¹æ€§æµ‹è¯•
- `test-esptool-loading.html` - esptool-jsåŠ è½½æµ‹è¯•

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### æ—¶åºä¼˜åŒ–

1. **æµé‡Šæ”¾ç­‰å¾…æ—¶é—´** - 200msç¡®ä¿å®Œå…¨è§£é”
2. **é‡è¯•é—´éš”** - é€’å¢ç­‰å¾…æ—¶é—´ï¼ˆ200ms/400ms/600msï¼‰
3. **èŠ¯ç‰‡ä¸‹è½½å™¨åˆå§‹åŒ–** - å»¶è¿Ÿ200msç­‰å¾…èµ„æºé‡Šæ”¾

### èµ„æºç®¡ç†

1. **ç¡®å®šæ€§çš„èµ„æºé‡Šæ”¾** - æ‰€æœ‰reader/writeréƒ½æœ‰æ˜ç¡®çš„é‡Šæ”¾é€»è¾‘
2. **å¼‚å¸¸å®‰å…¨** - å³ä½¿å‘ç”Ÿé”™è¯¯ä¹Ÿèƒ½æ­£ç¡®æ¸…ç†èµ„æº
3. **çŠ¶æ€éªŒè¯** - æ¯ä¸ªå…³é”®æ­¥éª¤éƒ½æœ‰çŠ¶æ€æ£€æŸ¥

## âœ… ä¿®å¤éªŒè¯æ¸…å•

- [x] **APIå…¼å®¹æ€§**: ä¸esptool-js 100%å¯¹é½
- [x] **æµç®¡ç†**: è§£å†³reader/writeré”å®šå†²çª
- [x] **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯æ£€æµ‹å’Œæ¢å¤
- [x] **ç”¨æˆ·ä½“éªŒ**: å‹å¥½çš„é”™è¯¯æç¤ºå’ŒæŒ‡å¯¼
- [x] **æµ‹è¯•è¦†ç›–**: å…¨é¢çš„æµ‹è¯•ç”¨ä¾‹
- [x] **æ–‡æ¡£**: å®Œæ•´çš„ä¿®å¤æ–‡æ¡£

## ğŸ“ ä¸»è¦æ–‡ä»¶ä¿®æ”¹

### 1. `web_serial/flash-downloader.js`
- æ–°å¢4ä¸ªæµç®¡ç†æ–¹æ³•
- æ”¹è¿›ä¸‹è½½æµç¨‹çš„é”™è¯¯å¤„ç†
- ESP32ç‰¹å®šçš„è¿æ¥é—®é¢˜è¯Šæ–­

### 2. `web_serial/downloaders/esp32-series-downloader.js`
- æ™ºèƒ½æµè·å–æœºåˆ¶
- å¢å¼ºçš„Transportå®ç°
- æ”¹è¿›çš„é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘

### 3. æµ‹è¯•æ–‡ä»¶
- `test-esp32-stream-fix.html` - æµç®¡ç†ä¸“é¡¹æµ‹è¯•
- å…¶ä»–æµ‹è¯•æ–‡ä»¶çš„æ›´æ–°å’Œæ”¹è¿›

## ğŸ‰ ç»“æœæ€»ç»“

**ä¿®å¤å‰çš„é—®é¢˜:**
- âŒ ReadableStreamDefaultReaderé”å®šé”™è¯¯
- âŒ ä¸‹è½½è¿‡ç¨‹ä¸­æ–­è¿æ¥
- âŒ é”™è¯¯æ¢å¤èƒ½åŠ›å·®
- âŒ ç”¨æˆ·ä½“éªŒä¸ä½³

**ä¿®å¤åçš„çŠ¶æ€:**
- âœ… æµé”å®šå†²çªå®Œå…¨è§£å†³
- âœ… ç¨³å®šçš„ä¸‹è½½æµç¨‹
- âœ… å¼ºå¤§çš„é”™è¯¯æ¢å¤èƒ½åŠ›
- âœ… ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒ
- âœ… 100% esptool-jså…¼å®¹æ€§

## ğŸ”® åç»­ç»´æŠ¤

1. **æŒç»­ç›‘æ§**: å…³æ³¨Web Serial APIçš„æ›´æ–°
2. **æ€§èƒ½ä¼˜åŒ–**: æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´æ—¶åºå‚æ•°
3. **å…¼å®¹æ€§**: ä¿æŒä¸æ–°ç‰ˆæœ¬esptool-jsçš„å…¼å®¹æ€§
4. **ç”¨æˆ·åé¦ˆ**: æ ¹æ®ç”¨æˆ·åé¦ˆè¿›ä¸€æ­¥ä¼˜åŒ–ä½“éªŒ

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2024å¹´6æœˆ10æ—¥  
**ä¿®å¤ä½œè€…**: AIåŠ©æ‰‹  
**ä¿®å¤çŠ¶æ€**: âœ… å®Œæˆå¹¶éªŒè¯  
**å…¼å®¹æ€§**: esptool-js v0.4.6+ 