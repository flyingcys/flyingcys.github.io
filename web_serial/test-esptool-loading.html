<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32å·¥å…·åº“åŠ è½½æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ESP32å·¥å…·åº“åŠ è½½æµ‹è¯•</h1>
        <p>è¿™ä¸ªé¡µé¢ç”¨æ¥éªŒè¯esptool-jsç­‰åº“çš„åŠ è½½æƒ…å†µ</p>
        
        <div id="loadingStatus" class="status-box">æ­£åœ¨åŠ è½½åº“æ–‡ä»¶...</div>
        
        <div>
            <button onclick="checkLibraries()">é‡æ–°æ£€æŸ¥åº“çŠ¶æ€</button>
            <button onclick="testBasicFunctions()">æµ‹è¯•åŸºæœ¬åŠŸèƒ½</button>
            <button onclick="showGlobalObjects()">æ˜¾ç¤ºå…¨å±€å¯¹è±¡</button>
        </div>
        
        <div id="testResults" class="status-box" style="display: none;"></div>
    </div>

    <script>
        let loadStatus = {
            esp32Downloader: false,
            esptooljs: false
        };
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('loadingStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status-box ${type}`;
        }
        
        function checkLibraries() {
            let status = 'åº“çŠ¶æ€æ£€æŸ¥ç»“æœ:\n\n';
            
            // æ£€æŸ¥Web Serial API
            if ('serial' in navigator) {
                status += 'âœ… Web Serial API: å¯ç”¨\n';
            } else {
                status += 'âŒ Web Serial API: ä¸å¯ç”¨\n';
            }
            
            // æ£€æŸ¥ESP32SimpleDownloader
            if (typeof ESP32SimpleDownloader !== 'undefined') {
                status += 'âœ… ESP32SimpleDownloader: å·²åŠ è½½\n';
                loadStatus.esp32Downloader = true;
            } else {
                status += 'âŒ ESP32SimpleDownloader: æœªåŠ è½½\n';
                loadStatus.esp32Downloader = false;
            }
            
            // æ£€æŸ¥esptool-jsï¼ˆåŸºäºå®é™…ç»“æ„ï¼‰
            let esptoolStatus = '';
            let esptoolFound = false;
            
            if (typeof window.esptooljs !== 'undefined') {
                esptoolStatus += 'âœ… window.esptooljs: å·²åŠ è½½\n';
                esptoolFound = true;
                
                const esptool = window.esptooljs;
                
                // æ£€æŸ¥å®é™…å­˜åœ¨çš„ç±»
                const expectedClasses = ['ESPLoader', 'ClassicReset', 'CustomReset', 'HardReset', 'ROM'];
                for (const className of expectedClasses) {
                    if (esptool[className]) {
                        esptoolStatus += `âœ… esptooljs.${className}: å·²åŠ è½½\n`;
                    } else {
                        esptoolStatus += `âŒ esptooljs.${className}: æœªæ‰¾åˆ°\n`;
                    }
                }
                
                // æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨çš„å¯¼å‡º
                const exports = Object.keys(esptool);
                if (exports.length > 0) {
                    esptoolStatus += `\nğŸ“¦ å®é™…å¯¼å‡º: ${exports.join(', ')}\n`;
                }
                
                // æ£€æŸ¥Transportæ˜¯å¦åœ¨ESPLoaderå†…éƒ¨
                if (esptool.ESPLoader) {
                    try {
                        const loaderProps = Object.getOwnPropertyNames(esptool.ESPLoader);
                        const loaderMethods = loaderProps.filter(prop => typeof esptool.ESPLoader[prop] === 'function');
                        if (loaderMethods.length > 0) {
                            esptoolStatus += `\nğŸ”§ ESPLoaderæ–¹æ³•: ${loaderMethods.slice(0, 5).join(', ')}${loaderMethods.length > 5 ? '...' : ''}\n`;
                        }
                    } catch (e) {
                        esptoolStatus += `\nâš ï¸ æ— æ³•æ£€æŸ¥ESPLoaderå†…éƒ¨ç»“æ„: ${e.message}\n`;
                    }
                }
                
            } else {
                esptoolStatus += 'âŒ window.esptooljs: æœªæ‰¾åˆ°\n';
                
                // æ£€æŸ¥æ—§çš„å…¨å±€æ–¹å¼ï¼ˆå‘åå…¼å®¹ï¼‰
                const legacyChecks = [
                    { name: 'window.ESPLoader', check: () => typeof window.ESPLoader !== 'undefined' },
                    { name: 'window.Transport', check: () => typeof window.Transport !== 'undefined' },
                ];
                
                for (const item of legacyChecks) {
                    try {
                        if (item.check()) {
                            esptoolStatus += `âœ… ${item.name}: å·²åŠ è½½ (ä¼ ç»Ÿæ–¹å¼)\n`;
                            esptoolFound = true;
                        } else {
                            esptoolStatus += `âŒ ${item.name}: æœªæ‰¾åˆ°\n`;
                        }
                    } catch (e) {
                        esptoolStatus += `âŒ ${item.name}: æ£€æŸ¥é”™è¯¯ (${e.message})\n`;
                    }
                }
            }
            
            status += esptoolStatus;
            loadStatus.esptooljs = esptoolFound;
            
            if (esptoolFound) {
                status += '\nâœ… esptool-js: åŠŸèƒ½å¯ç”¨';
            } else {
                status += '\nâŒ esptool-js: æœªæ£€æµ‹åˆ°ä»»ä½•åŠŸèƒ½';
            }
            
            updateStatus(status, esptoolFound && loadStatus.esp32Downloader ? 'success' : 'warning');
        }
        
        function testBasicFunctions() {
            let results = 'åŸºæœ¬åŠŸèƒ½æµ‹è¯•:\n\n';
            
            // æµ‹è¯•ESP32SimpleDownloader
            if (loadStatus.esp32Downloader) {
                try {
                    const downloader = new ESP32SimpleDownloader();
                    results += 'âœ… ESP32SimpleDownloader: å¯ä»¥å®ä¾‹åŒ–\n';
                    
                    // æµ‹è¯•åŸºæœ¬æ–¹æ³•
                    if (typeof downloader.ui8ToBstr === 'function') {
                        const testData = new Uint8Array([0x01, 0x02, 0x03]);
                        const converted = downloader.ui8ToBstr(testData);
                        results += `âœ… ui8ToBstr: å·¥ä½œæ­£å¸¸ (${testData.length} -> ${converted.length})\n`;
                    }
                    
                    if (typeof downloader.calculateChecksum === 'function') {
                        results += 'âœ… calculateChecksum: æ–¹æ³•å­˜åœ¨\n';
                    }
                    
                    if (typeof downloader.appendArray === 'function') {
                        const arr1 = new Uint8Array([1, 2]);
                        const arr2 = new Uint8Array([3, 4]);
                        const combined = downloader.appendArray(arr1, arr2);
                        results += `âœ… appendArray: å·¥ä½œæ­£å¸¸ ([1,2] + [3,4] = [${Array.from(combined)}])\n`;
                    }
                    
                } catch (e) {
                    results += `âŒ ESP32SimpleDownloader: æµ‹è¯•å¤±è´¥ (${e.message})\n`;
                }
            } else {
                results += 'âŒ ESP32SimpleDownloader: æœªåŠ è½½ï¼Œè·³è¿‡æµ‹è¯•\n';
            }
            
            // æµ‹è¯•esptool-jsï¼ˆåŸºäºå®é™…ç»“æ„ï¼‰
            if (loadStatus.esptooljs) {
                try {
                    if (typeof window.esptooljs !== 'undefined') {
                        const esptool = window.esptooljs;
                        results += 'âœ… esptooljs: å…¨å±€å¯¹è±¡å¯ç”¨\n';
                        
                        // æµ‹è¯•ESPLoader
                        if (esptool.ESPLoader) {
                            results += 'âœ… esptooljs.ESPLoader: ç±»å¯ç”¨\n';
                            
                            // æ£€æŸ¥ESPLoaderçš„æ–¹æ³•
                            try {
                                const methods = Object.getOwnPropertyNames(esptool.ESPLoader);
                                const staticMethods = methods.filter(method => typeof esptool.ESPLoader[method] === 'function');
                                if (staticMethods.length > 0) {
                                    results += `   é™æ€æ–¹æ³•: ${staticMethods.slice(0, 3).join(', ')}${staticMethods.length > 3 ? '...' : ''}\n`;
                                }
                                
                                // æ£€æŸ¥åŸå‹æ–¹æ³•
                                if (esptool.ESPLoader.prototype) {
                                    const prototypeMethods = Object.getOwnPropertyNames(esptool.ESPLoader.prototype)
                                        .filter(method => typeof esptool.ESPLoader.prototype[method] === 'function');
                                    if (prototypeMethods.length > 0) {
                                        results += `   å®ä¾‹æ–¹æ³•: ${prototypeMethods.slice(0, 3).join(', ')}${prototypeMethods.length > 3 ? '...' : ''}\n`;
                                    }
                                }
                            } catch (e) {
                                results += `   âš ï¸ æ–¹æ³•æ£€æŸ¥å¤±è´¥: ${e.message}\n`;
                            }
                        } else {
                            results += 'âŒ esptooljs.ESPLoader: æœªæ‰¾åˆ°\n';
                        }
                        
                        // æµ‹è¯•Resetç±»
                        const resetClasses = ['ClassicReset', 'CustomReset', 'HardReset'];
                        for (const resetClass of resetClasses) {
                            if (esptool[resetClass]) {
                                results += `âœ… esptooljs.${resetClass}: ç±»å¯ç”¨\n`;
                            }
                        }
                        
                        // æµ‹è¯•ROMç±»
                        if (esptool.ROM) {
                            results += 'âœ… esptooljs.ROM: ç±»å¯ç”¨\n';
                            
                            // æ£€æŸ¥ROMç›¸å…³çš„å¸¸é‡æˆ–æ–¹æ³•
                            try {
                                const romMethods = Object.getOwnPropertyNames(esptool.ROM);
                                if (romMethods.length > 0) {
                                    results += `   ROMåŠŸèƒ½: ${romMethods.slice(0, 3).join(', ')}${romMethods.length > 3 ? '...' : ''}\n`;
                                }
                            } catch (e) {
                                results += `   âš ï¸ ROMæ£€æŸ¥å¤±è´¥: ${e.message}\n`;
                            }
                        }
                        
                        // å°è¯•æ£€æŸ¥æ˜¯å¦æœ‰Transportç›¸å…³åŠŸèƒ½
                        results += '\nğŸ” å¯»æ‰¾TransportåŠŸèƒ½...\n';
                        const allKeys = Object.keys(esptool);
                        const transportRelated = allKeys.filter(key => 
                            key.toLowerCase().includes('transport') || 
                            key.toLowerCase().includes('serial') ||
                            key.toLowerCase().includes('port')
                        );
                        
                        if (transportRelated.length > 0) {
                            results += `   å‘ç°ç›¸å…³åŠŸèƒ½: ${transportRelated.join(', ')}\n`;
                        } else {
                            results += '   æœªå‘ç°Transportç›¸å…³åŠŸèƒ½\n';
                            results += '   æ³¨æ„: Transportå¯èƒ½åœ¨ä½¿ç”¨æ—¶åŠ¨æ€åˆ›å»º\n';
                        }
                        
                    }
                } catch (e) {
                    results += `âŒ esptool-js: æµ‹è¯•å¤±è´¥ (${e.message})\n`;
                }
            } else {
                results += 'âŒ esptool-js: æœªåŠ è½½ï¼Œè·³è¿‡æµ‹è¯•\n';
            }
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.textContent = results;
            resultsDiv.style.display = 'block';
            resultsDiv.className = 'status-box info';
        }
        
        function showGlobalObjects() {
            let objects = 'å…¨å±€å¯¹è±¡åˆ†æ:\n\n';
            
            const interestingObjects = [
                'esptooljs', 'ESPLoader', 'Transport', 'ESP32SimpleDownloader',
                'WebSerial', 'navigator'
            ];
            
            for (const name of interestingObjects) {
                try {
                    const obj = window[name];
                    if (obj !== undefined) {
                        objects += `âœ… ${name}: ${typeof obj}\n`;
                        
                        if (typeof obj === 'object' && obj !== null) {
                            const keys = Object.keys(obj).slice(0, 5);
                            if (keys.length > 0) {
                                objects += `   å±æ€§: ${keys.join(', ')}${keys.length > 5 ? '...' : ''}\n`;
                            }
                        }
                    } else {
                        objects += `âŒ ${name}: æœªå®šä¹‰\n`;
                    }
                } catch (e) {
                    objects += `âŒ ${name}: è®¿é—®é”™è¯¯ (${e.message})\n`;
                }
            }
            
            // æ£€æŸ¥navigator.serial
            if (navigator.serial) {
                objects += '\nâœ… navigator.serial: å¯ç”¨\n';
                objects += `   æ–¹æ³•: ${Object.getOwnPropertyNames(navigator.serial).join(', ')}\n`;
            }
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.textContent = objects;
            resultsDiv.style.display = 'block';
            resultsDiv.className = 'status-box info';
        }
        
        // è‡ªåŠ¨åŠ è½½è„šæœ¬
        let scriptsToLoad = 2;
        let scriptsLoaded = 0;
        
        function onScriptLoaded() {
            scriptsLoaded++;
            updateStatus(`æ­£åœ¨åŠ è½½åº“æ–‡ä»¶... (${scriptsLoaded}/${scriptsToLoad})`);
            
            if (scriptsLoaded >= scriptsToLoad) {
                setTimeout(() => {
                    updateStatus('åº“æ–‡ä»¶åŠ è½½å®Œæˆï¼Œæ­£åœ¨æ£€æŸ¥çŠ¶æ€...', 'info');
                    setTimeout(() => {
                        checkLibraries();
                    }, 500);
                }, 500);
            }
        }
        
        // åŠ è½½ESP32SimpleDownloader
        const script1 = document.createElement('script');
        script1.src = './downloaders/esp32-simple-downloader.js';
        script1.onload = () => {
            console.log('âœ… ESP32SimpleDownloader loaded');
            onScriptLoaded();
        };
        script1.onerror = () => {
            console.error('âŒ Failed to load ESP32SimpleDownloader');
            onScriptLoaded();
        };
        document.head.appendChild(script1);
        
        // åŠ è½½esptool-js
        const script2 = document.createElement('script');
        script2.src = './third_party/esptool-js/bundle.js';
        script2.onload = () => {
            console.log('âœ… esptool-js loaded');
            // ç»™ä¸€ç‚¹æ—¶é—´è®©å…¨å±€å¯¹è±¡åˆå§‹åŒ–
            setTimeout(() => {
                onScriptLoaded();
            }, 200);
        };
        script2.onerror = () => {
            console.error('âŒ Failed to load esptool-js');
            onScriptLoaded();
        };
        document.head.appendChild(script2);
    </script>
</body>
</html> 