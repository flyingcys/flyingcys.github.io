<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32工具库加载测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 ESP32工具库加载测试</h1>
        <p>这个页面用来验证esptool-js等库的加载情况</p>
        
        <div id="loadingStatus" class="status-box">正在加载库文件...</div>
        
        <div>
            <button onclick="checkLibraries()">重新检查库状态</button>
            <button onclick="testBasicFunctions()">测试基本功能</button>
            <button onclick="showGlobalObjects()">显示全局对象</button>
        </div>
        
        <div id="testResults" class="status-box" style="display: none;"></div>
    </div>

    <script>
        let loadStatus = {
            esp32Downloader: false,
            esptooljs: false
        };
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('loadingStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status-box ${type}`;
        }
        
        function checkLibraries() {
            let status = '库状态检查结果:\n\n';
            
            // 检查Web Serial API
            if ('serial' in navigator) {
                status += '✅ Web Serial API: 可用\n';
            } else {
                status += '❌ Web Serial API: 不可用\n';
            }
            
            // 检查ESP32SimpleDownloader
            if (typeof ESP32SimpleDownloader !== 'undefined') {
                status += '✅ ESP32SimpleDownloader: 已加载\n';
                loadStatus.esp32Downloader = true;
            } else {
                status += '❌ ESP32SimpleDownloader: 未加载\n';
                loadStatus.esp32Downloader = false;
            }
            
            // 检查esptool-js（基于实际结构）
            let esptoolStatus = '';
            let esptoolFound = false;
            
            if (typeof window.esptooljs !== 'undefined') {
                esptoolStatus += '✅ window.esptooljs: 已加载\n';
                esptoolFound = true;
                
                const esptool = window.esptooljs;
                
                // 检查实际存在的类
                const expectedClasses = ['ESPLoader', 'ClassicReset', 'CustomReset', 'HardReset', 'ROM'];
                for (const className of expectedClasses) {
                    if (esptool[className]) {
                        esptoolStatus += `✅ esptooljs.${className}: 已加载\n`;
                    } else {
                        esptoolStatus += `❌ esptooljs.${className}: 未找到\n`;
                    }
                }
                
                // 显示所有可用的导出
                const exports = Object.keys(esptool);
                if (exports.length > 0) {
                    esptoolStatus += `\n📦 实际导出: ${exports.join(', ')}\n`;
                }
                
                // 检查Transport是否在ESPLoader内部
                if (esptool.ESPLoader) {
                    try {
                        const loaderProps = Object.getOwnPropertyNames(esptool.ESPLoader);
                        const loaderMethods = loaderProps.filter(prop => typeof esptool.ESPLoader[prop] === 'function');
                        if (loaderMethods.length > 0) {
                            esptoolStatus += `\n🔧 ESPLoader方法: ${loaderMethods.slice(0, 5).join(', ')}${loaderMethods.length > 5 ? '...' : ''}\n`;
                        }
                    } catch (e) {
                        esptoolStatus += `\n⚠️ 无法检查ESPLoader内部结构: ${e.message}\n`;
                    }
                }
                
            } else {
                esptoolStatus += '❌ window.esptooljs: 未找到\n';
                
                // 检查旧的全局方式（向后兼容）
                const legacyChecks = [
                    { name: 'window.ESPLoader', check: () => typeof window.ESPLoader !== 'undefined' },
                    { name: 'window.Transport', check: () => typeof window.Transport !== 'undefined' },
                ];
                
                for (const item of legacyChecks) {
                    try {
                        if (item.check()) {
                            esptoolStatus += `✅ ${item.name}: 已加载 (传统方式)\n`;
                            esptoolFound = true;
                        } else {
                            esptoolStatus += `❌ ${item.name}: 未找到\n`;
                        }
                    } catch (e) {
                        esptoolStatus += `❌ ${item.name}: 检查错误 (${e.message})\n`;
                    }
                }
            }
            
            status += esptoolStatus;
            loadStatus.esptooljs = esptoolFound;
            
            if (esptoolFound) {
                status += '\n✅ esptool-js: 功能可用';
            } else {
                status += '\n❌ esptool-js: 未检测到任何功能';
            }
            
            updateStatus(status, esptoolFound && loadStatus.esp32Downloader ? 'success' : 'warning');
        }
        
        function testBasicFunctions() {
            let results = '基本功能测试:\n\n';
            
            // 测试ESP32SimpleDownloader
            if (loadStatus.esp32Downloader) {
                try {
                    const downloader = new ESP32SimpleDownloader();
                    results += '✅ ESP32SimpleDownloader: 可以实例化\n';
                    
                    // 测试基本方法
                    if (typeof downloader.ui8ToBstr === 'function') {
                        const testData = new Uint8Array([0x01, 0x02, 0x03]);
                        const converted = downloader.ui8ToBstr(testData);
                        results += `✅ ui8ToBstr: 工作正常 (${testData.length} -> ${converted.length})\n`;
                    }
                    
                    if (typeof downloader.calculateChecksum === 'function') {
                        results += '✅ calculateChecksum: 方法存在\n';
                    }
                    
                    if (typeof downloader.appendArray === 'function') {
                        const arr1 = new Uint8Array([1, 2]);
                        const arr2 = new Uint8Array([3, 4]);
                        const combined = downloader.appendArray(arr1, arr2);
                        results += `✅ appendArray: 工作正常 ([1,2] + [3,4] = [${Array.from(combined)}])\n`;
                    }
                    
                } catch (e) {
                    results += `❌ ESP32SimpleDownloader: 测试失败 (${e.message})\n`;
                }
            } else {
                results += '❌ ESP32SimpleDownloader: 未加载，跳过测试\n';
            }
            
            // 测试esptool-js（基于实际结构）
            if (loadStatus.esptooljs) {
                try {
                    if (typeof window.esptooljs !== 'undefined') {
                        const esptool = window.esptooljs;
                        results += '✅ esptooljs: 全局对象可用\n';
                        
                        // 测试ESPLoader
                        if (esptool.ESPLoader) {
                            results += '✅ esptooljs.ESPLoader: 类可用\n';
                            
                            // 检查ESPLoader的方法
                            try {
                                const methods = Object.getOwnPropertyNames(esptool.ESPLoader);
                                const staticMethods = methods.filter(method => typeof esptool.ESPLoader[method] === 'function');
                                if (staticMethods.length > 0) {
                                    results += `   静态方法: ${staticMethods.slice(0, 3).join(', ')}${staticMethods.length > 3 ? '...' : ''}\n`;
                                }
                                
                                // 检查原型方法
                                if (esptool.ESPLoader.prototype) {
                                    const prototypeMethods = Object.getOwnPropertyNames(esptool.ESPLoader.prototype)
                                        .filter(method => typeof esptool.ESPLoader.prototype[method] === 'function');
                                    if (prototypeMethods.length > 0) {
                                        results += `   实例方法: ${prototypeMethods.slice(0, 3).join(', ')}${prototypeMethods.length > 3 ? '...' : ''}\n`;
                                    }
                                }
                            } catch (e) {
                                results += `   ⚠️ 方法检查失败: ${e.message}\n`;
                            }
                        } else {
                            results += '❌ esptooljs.ESPLoader: 未找到\n';
                        }
                        
                        // 测试Reset类
                        const resetClasses = ['ClassicReset', 'CustomReset', 'HardReset'];
                        for (const resetClass of resetClasses) {
                            if (esptool[resetClass]) {
                                results += `✅ esptooljs.${resetClass}: 类可用\n`;
                            }
                        }
                        
                        // 测试ROM类
                        if (esptool.ROM) {
                            results += '✅ esptooljs.ROM: 类可用\n';
                            
                            // 检查ROM相关的常量或方法
                            try {
                                const romMethods = Object.getOwnPropertyNames(esptool.ROM);
                                if (romMethods.length > 0) {
                                    results += `   ROM功能: ${romMethods.slice(0, 3).join(', ')}${romMethods.length > 3 ? '...' : ''}\n`;
                                }
                            } catch (e) {
                                results += `   ⚠️ ROM检查失败: ${e.message}\n`;
                            }
                        }
                        
                        // 尝试检查是否有Transport相关功能
                        results += '\n🔍 寻找Transport功能...\n';
                        const allKeys = Object.keys(esptool);
                        const transportRelated = allKeys.filter(key => 
                            key.toLowerCase().includes('transport') || 
                            key.toLowerCase().includes('serial') ||
                            key.toLowerCase().includes('port')
                        );
                        
                        if (transportRelated.length > 0) {
                            results += `   发现相关功能: ${transportRelated.join(', ')}\n`;
                        } else {
                            results += '   未发现Transport相关功能\n';
                            results += '   注意: Transport可能在使用时动态创建\n';
                        }
                        
                    }
                } catch (e) {
                    results += `❌ esptool-js: 测试失败 (${e.message})\n`;
                }
            } else {
                results += '❌ esptool-js: 未加载，跳过测试\n';
            }
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.textContent = results;
            resultsDiv.style.display = 'block';
            resultsDiv.className = 'status-box info';
        }
        
        function showGlobalObjects() {
            let objects = '全局对象分析:\n\n';
            
            const interestingObjects = [
                'esptooljs', 'ESPLoader', 'Transport', 'ESP32SimpleDownloader',
                'WebSerial', 'navigator'
            ];
            
            for (const name of interestingObjects) {
                try {
                    const obj = window[name];
                    if (obj !== undefined) {
                        objects += `✅ ${name}: ${typeof obj}\n`;
                        
                        if (typeof obj === 'object' && obj !== null) {
                            const keys = Object.keys(obj).slice(0, 5);
                            if (keys.length > 0) {
                                objects += `   属性: ${keys.join(', ')}${keys.length > 5 ? '...' : ''}\n`;
                            }
                        }
                    } else {
                        objects += `❌ ${name}: 未定义\n`;
                    }
                } catch (e) {
                    objects += `❌ ${name}: 访问错误 (${e.message})\n`;
                }
            }
            
            // 检查navigator.serial
            if (navigator.serial) {
                objects += '\n✅ navigator.serial: 可用\n';
                objects += `   方法: ${Object.getOwnPropertyNames(navigator.serial).join(', ')}\n`;
            }
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.textContent = objects;
            resultsDiv.style.display = 'block';
            resultsDiv.className = 'status-box info';
        }
        
        // 自动加载脚本
        let scriptsToLoad = 2;
        let scriptsLoaded = 0;
        
        function onScriptLoaded() {
            scriptsLoaded++;
            updateStatus(`正在加载库文件... (${scriptsLoaded}/${scriptsToLoad})`);
            
            if (scriptsLoaded >= scriptsToLoad) {
                setTimeout(() => {
                    updateStatus('库文件加载完成，正在检查状态...', 'info');
                    setTimeout(() => {
                        checkLibraries();
                    }, 500);
                }, 500);
            }
        }
        
        // 加载ESP32SimpleDownloader
        const script1 = document.createElement('script');
        script1.src = './downloaders/esp32-simple-downloader.js';
        script1.onload = () => {
            console.log('✅ ESP32SimpleDownloader loaded');
            onScriptLoaded();
        };
        script1.onerror = () => {
            console.error('❌ Failed to load ESP32SimpleDownloader');
            onScriptLoaded();
        };
        document.head.appendChild(script1);
        
        // 加载esptool-js
        const script2 = document.createElement('script');
        script2.src = './third_party/esptool-js/bundle.js';
        script2.onload = () => {
            console.log('✅ esptool-js loaded');
            // 给一点时间让全局对象初始化
            setTimeout(() => {
                onScriptLoaded();
            }, 200);
        };
        script2.onerror = () => {
            console.error('❌ Failed to load esptool-js');
            onScriptLoaded();
        };
        document.head.appendChild(script2);
    </script>
</body>
</html> 