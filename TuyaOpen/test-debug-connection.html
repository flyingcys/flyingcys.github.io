<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 è¿æ¥è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #1e1e1e; color: #00ff00; padding: 20px; border-radius: 8px; height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .status { margin: 15px 0; padding: 15px; border-radius: 8px; font-weight: bold; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.success { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <h1>ğŸ”§ ESP32 è¿æ¥è°ƒè¯•å·¥å…·</h1>
    
    <div>
        <button id="connectBtn">è¿æ¥ESP32</button>
        <button id="testTransportBtn" disabled>æµ‹è¯•Transport</button>
        <button id="testSyncBtn" disabled>æµ‹è¯•Sync</button>
        <button id="testChipDetectBtn" disabled>æµ‹è¯•èŠ¯ç‰‡æ£€æµ‹</button>
    </div>
    
    <div id="status" class="status">ç­‰å¾…è¿æ¥</div>
    
    <div class="log" id="logArea"></div>

    <script type="module">
        import ESP32SeriesDownloader from './downloaders/esp32-series-downloader.js';

        class DebugTester {
            constructor() {
                this.downloader = null;
                this.serialPort = null;
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('connectBtn').addEventListener('click', () => this.connect());
                document.getElementById('testTransportBtn').addEventListener('click', () => this.testTransport());
                document.getElementById('testSyncBtn').addEventListener('click', () => this.testSync());
                document.getElementById('testChipDetectBtn').addEventListener('click', () => this.testChipDetect());
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logArea = document.getElementById('logArea');
                const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'debug' ? 'ğŸ”' : 'â„¹ï¸';
                logArea.textContent += `[${timestamp}] ${prefix} ${message}\n`;
                logArea.scrollTop = logArea.scrollHeight;
            }

            updateStatus(message, type = 'info') {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `status ${type}`;
            }

            async connect() {
                try {
                    this.log('=== å¼€å§‹è¿æ¥æµ‹è¯• ===');
                    
                    // æ­¥éª¤1: è¯·æ±‚ä¸²å£
                    this.log('æ­¥éª¤1: è¯·æ±‚ä¸²å£æƒé™...');
                    this.serialPort = await navigator.serial.requestPort();
                    this.log('ä¸²å£é€‰æ‹©æˆåŠŸ', 'success');
                    
                    // æ­¥éª¤2: æ£€æŸ¥ä¸²å£çŠ¶æ€
                    this.log(`æ­¥éª¤2: ä¸²å£çŠ¶æ€ - readable: ${!!this.serialPort.readable}, writable: ${!!this.serialPort.writable}`);
                    
                    // æ­¥éª¤3: åˆ›å»ºä¸‹è½½å™¨å®ä¾‹
                    this.log('æ­¥éª¤3: åˆ›å»ºESP32SeriesDownloaderå®ä¾‹...');
                    this.downloader = new ESP32SeriesDownloader(this.serialPort, {
                        log: (msg) => this.log(`[LOG] ${msg}`, 'debug'),
                        error: (msg) => this.log(`[ERROR] ${msg}`, 'error'),
                        info: (msg) => this.log(`[INFO] ${msg}`, 'info'),
                        debug: (msg) => this.log(`[DEBUG] ${msg}`, 'debug')
                    });
                    this.log('ESP32SeriesDownloader å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                    
                    // æ­¥éª¤4: æ‰“å¼€ä¸²å£
                    if (!this.serialPort.readable) {
                        this.log('æ­¥éª¤4: æ‰“å¼€ä¸²å£...');
                        await this.serialPort.open({ baudRate: 115200 });
                        this.log('ä¸²å£å·²æ‰“å¼€', 'success');
                    } else {
                        this.log('æ­¥éª¤4: ä¸²å£å·²ç»æ‰“å¼€', 'success');
                    }
                    
                    // æ­¥éª¤5: åˆ›å»ºTransport
                    this.log('æ­¥éª¤5: åˆ›å»ºè‡ªå®šä¹‰Transport...');
                    this.downloader.customTransport = this.downloader.createCustomTransport();
                    this.log('Transportåˆ›å»ºæˆåŠŸ', 'success');
                    
                    // å¯ç”¨æµ‹è¯•æŒ‰é’®
                    document.getElementById('testTransportBtn').disabled = false;
                    document.getElementById('testSyncBtn').disabled = false;
                    document.getElementById('testChipDetectBtn').disabled = false;
                    document.getElementById('connectBtn').disabled = true;
                    
                    this.updateStatus('ä¸²å£å’ŒTransportå‡†å¤‡å°±ç»ª', 'success');
                    this.log('=== è¿æ¥å‡†å¤‡å®Œæˆ ===', 'success');
                    
                } catch (error) {
                    this.log(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                    this.log(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
                    this.updateStatus(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                }
            }

            async testTransport() {
                try {
                    this.log('=== æµ‹è¯•Transportè¿æ¥ ===');
                    
                    // è¿æ¥Transport
                    this.log('æ­£åœ¨è¿æ¥Transport...');
                    await this.downloader.customTransport.connect(115200);
                    this.log('Transportè¿æ¥æˆåŠŸ', 'success');
                    
                } catch (error) {
                    this.log(`Transportæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                    this.log(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
                }
            }

            async testSync() {
                try {
                    this.log('=== æµ‹è¯•åŒæ­¥é€šä¿¡ ===');
                    
                    // æµ‹è¯•åˆ·æ–°è¾“å…¥
                    this.log('æ¸…ç©ºè¾“å…¥ç¼“å†²åŒº...');
                    await this.downloader.flushInput();
                    this.log('è¾“å…¥ç¼“å†²åŒºæ¸…ç©ºå®Œæˆ');
                    
                    // æµ‹è¯•åŒæ­¥
                    this.log('å‘é€åŒæ­¥å‘½ä»¤...');
                    await this.downloader.sync();
                    this.log('åŒæ­¥æˆåŠŸï¼', 'success');
                    
                } catch (error) {
                    this.log(`åŒæ­¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                    this.log(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
                }
            }

            async testChipDetect() {
                try {
                    this.log('=== æµ‹è¯•èŠ¯ç‰‡æ£€æµ‹ ===');
                    
                    // è¯»å–èŠ¯ç‰‡æ£€æµ‹å¯„å­˜å™¨
                    this.log('è¯»å–èŠ¯ç‰‡æ£€æµ‹å¯„å­˜å™¨...');
                    const magicAddr = ESP32SeriesDownloader.CHIP_DETECT_MAGIC_REG_ADDR;
                    this.log(`èŠ¯ç‰‡æ£€æµ‹å¯„å­˜å™¨åœ°å€: 0x${magicAddr.toString(16)}`);
                    
                    const chipMagicValue = await this.downloader.readReg(magicAddr);
                    this.log(`èŠ¯ç‰‡Magicå€¼: 0x${chipMagicValue.toString(16)}`, 'success');
                    
                    // æŸ¥æ‰¾èŠ¯ç‰‡ç±»å‹
                    this.log('æŸ¥æ‰¾èŠ¯ç‰‡ç±»å‹...');
                    const chip = await this.downloader.magic2Chip(chipMagicValue);
                    
                    if (chip) {
                        this.log(`èŠ¯ç‰‡æ£€æµ‹æˆåŠŸ: ${chip.CHIP_NAME}`, 'success');
                        this.downloader.chip = chip;
                        this.updateStatus(`èŠ¯ç‰‡å·²æ£€æµ‹: ${chip.CHIP_NAME}`, 'success');
                        
                        // è·å–èŠ¯ç‰‡è¯¦ç»†ä¿¡æ¯
                        this.log('è·å–èŠ¯ç‰‡è¯¦ç»†ä¿¡æ¯...');
                        try {
                            const description = await chip.getChipDescription(this.downloader);
                            this.log(`èŠ¯ç‰‡æè¿°: ${description}`);
                            
                            const features = await chip.getChipFeatures(this.downloader);
                            this.log(`èŠ¯ç‰‡ç‰¹æ€§: ${features.join(', ')}`);
                            
                            const freq = await chip.getCrystalFreq(this.downloader);
                            this.log(`æ™¶æŒ¯é¢‘ç‡: ${freq}MHz`);
                            
                            const mac = await chip.readMac(this.downloader);
                            this.log(`MACåœ°å€: ${mac}`);
                            
                        } catch (infoError) {
                            this.log(`è·å–èŠ¯ç‰‡ä¿¡æ¯æ—¶å‡ºé”™: ${infoError.message}`, 'error');
                        }
                        
                    } else {
                        throw new Error(`æœªçŸ¥çš„èŠ¯ç‰‡Magicå€¼: 0x${chipMagicValue.toString(16)}`);
                    }
                    
                } catch (error) {
                    this.log(`èŠ¯ç‰‡æ£€æµ‹å¤±è´¥: ${error.message}`, 'error');
                    this.log(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
                }
            }
        }

        // å¯åŠ¨æµ‹è¯•å·¥å…·
        new DebugTester();
    </script>
</body>
</html> 