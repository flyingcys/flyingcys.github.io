<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 连接调试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #1e1e1e; color: #00ff00; padding: 20px; border-radius: 8px; height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .status { margin: 15px 0; padding: 15px; border-radius: 8px; font-weight: bold; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.success { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <h1>🔧 ESP32 连接调试工具</h1>
    
    <div>
        <button id="connectBtn">连接ESP32</button>
        <button id="testTransportBtn" disabled>测试Transport</button>
        <button id="testSyncBtn" disabled>测试Sync</button>
        <button id="testChipDetectBtn" disabled>测试芯片检测</button>
    </div>
    
    <div id="status" class="status">等待连接</div>
    
    <div class="log" id="logArea"></div>

    <script type="module">
        import ESP32SeriesDownloader from './downloaders/esp32-series-downloader.js';

        class DebugTester {
            constructor() {
                this.downloader = null;
                this.serialPort = null;
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('connectBtn').addEventListener('click', () => this.connect());
                document.getElementById('testTransportBtn').addEventListener('click', () => this.testTransport());
                document.getElementById('testSyncBtn').addEventListener('click', () => this.testSync());
                document.getElementById('testChipDetectBtn').addEventListener('click', () => this.testChipDetect());
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logArea = document.getElementById('logArea');
                const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'debug' ? '🔍' : 'ℹ️';
                logArea.textContent += `[${timestamp}] ${prefix} ${message}\n`;
                logArea.scrollTop = logArea.scrollHeight;
            }

            updateStatus(message, type = 'info') {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `status ${type}`;
            }

            async connect() {
                try {
                    this.log('=== 开始连接测试 ===');
                    
                    // 步骤1: 请求串口
                    this.log('步骤1: 请求串口权限...');
                    this.serialPort = await navigator.serial.requestPort();
                    this.log('串口选择成功', 'success');
                    
                    // 步骤2: 检查串口状态
                    this.log(`步骤2: 串口状态 - readable: ${!!this.serialPort.readable}, writable: ${!!this.serialPort.writable}`);
                    
                    // 步骤3: 创建下载器实例
                    this.log('步骤3: 创建ESP32SeriesDownloader实例...');
                    this.downloader = new ESP32SeriesDownloader(this.serialPort, {
                        log: (msg) => this.log(`[LOG] ${msg}`, 'debug'),
                        error: (msg) => this.log(`[ERROR] ${msg}`, 'error'),
                        info: (msg) => this.log(`[INFO] ${msg}`, 'info'),
                        debug: (msg) => this.log(`[DEBUG] ${msg}`, 'debug')
                    });
                    this.log('ESP32SeriesDownloader 实例创建成功', 'success');
                    
                    // 步骤4: 打开串口
                    if (!this.serialPort.readable) {
                        this.log('步骤4: 打开串口...');
                        await this.serialPort.open({ baudRate: 115200 });
                        this.log('串口已打开', 'success');
                    } else {
                        this.log('步骤4: 串口已经打开', 'success');
                    }
                    
                    // 步骤5: 创建Transport
                    this.log('步骤5: 创建自定义Transport...');
                    this.downloader.customTransport = this.downloader.createCustomTransport();
                    this.log('Transport创建成功', 'success');
                    
                    // 启用测试按钮
                    document.getElementById('testTransportBtn').disabled = false;
                    document.getElementById('testSyncBtn').disabled = false;
                    document.getElementById('testChipDetectBtn').disabled = false;
                    document.getElementById('connectBtn').disabled = true;
                    
                    this.updateStatus('串口和Transport准备就绪', 'success');
                    this.log('=== 连接准备完成 ===', 'success');
                    
                } catch (error) {
                    this.log(`连接失败: ${error.message}`, 'error');
                    this.log(`错误堆栈: ${error.stack}`, 'error');
                    this.updateStatus(`连接失败: ${error.message}`, 'error');
                }
            }

            async testTransport() {
                try {
                    this.log('=== 测试Transport连接 ===');
                    
                    // 连接Transport
                    this.log('正在连接Transport...');
                    await this.downloader.customTransport.connect(115200);
                    this.log('Transport连接成功', 'success');
                    
                } catch (error) {
                    this.log(`Transport测试失败: ${error.message}`, 'error');
                    this.log(`错误堆栈: ${error.stack}`, 'error');
                }
            }

            async testSync() {
                try {
                    this.log('=== 测试同步通信 ===');
                    
                    // 测试刷新输入
                    this.log('清空输入缓冲区...');
                    await this.downloader.flushInput();
                    this.log('输入缓冲区清空完成');
                    
                    // 测试同步
                    this.log('发送同步命令...');
                    await this.downloader.sync();
                    this.log('同步成功！', 'success');
                    
                } catch (error) {
                    this.log(`同步测试失败: ${error.message}`, 'error');
                    this.log(`错误堆栈: ${error.stack}`, 'error');
                }
            }

            async testChipDetect() {
                try {
                    this.log('=== 测试芯片检测 ===');
                    
                    // 读取芯片检测寄存器
                    this.log('读取芯片检测寄存器...');
                    const magicAddr = ESP32SeriesDownloader.CHIP_DETECT_MAGIC_REG_ADDR;
                    this.log(`芯片检测寄存器地址: 0x${magicAddr.toString(16)}`);
                    
                    const chipMagicValue = await this.downloader.readReg(magicAddr);
                    this.log(`芯片Magic值: 0x${chipMagicValue.toString(16)}`, 'success');
                    
                    // 查找芯片类型
                    this.log('查找芯片类型...');
                    const chip = await this.downloader.magic2Chip(chipMagicValue);
                    
                    if (chip) {
                        this.log(`芯片检测成功: ${chip.CHIP_NAME}`, 'success');
                        this.downloader.chip = chip;
                        this.updateStatus(`芯片已检测: ${chip.CHIP_NAME}`, 'success');
                        
                        // 获取芯片详细信息
                        this.log('获取芯片详细信息...');
                        try {
                            const description = await chip.getChipDescription(this.downloader);
                            this.log(`芯片描述: ${description}`);
                            
                            const features = await chip.getChipFeatures(this.downloader);
                            this.log(`芯片特性: ${features.join(', ')}`);
                            
                            const freq = await chip.getCrystalFreq(this.downloader);
                            this.log(`晶振频率: ${freq}MHz`);
                            
                            const mac = await chip.readMac(this.downloader);
                            this.log(`MAC地址: ${mac}`);
                            
                        } catch (infoError) {
                            this.log(`获取芯片信息时出错: ${infoError.message}`, 'error');
                        }
                        
                    } else {
                        throw new Error(`未知的芯片Magic值: 0x${chipMagicValue.toString(16)}`);
                    }
                    
                } catch (error) {
                    this.log(`芯片检测失败: ${error.message}`, 'error');
                    this.log(`错误堆栈: ${error.stack}`, 'error');
                }
            }
        }

        // 启动测试工具
        new DebugTester();
    </script>
</body>
</html> 