<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>🎉 最终修复验证</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .log { 
            background: rgba(0,0,0,0.8); 
            padding: 15px; 
            height: 400px; 
            overflow-y: auto; 
            font-family: monospace; 
            border-radius: 10px;
            margin: 15px 0;
        }
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            background: #28a745; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover { 
            background: #218838; 
            transform: translateY(-2px);
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        h1 { text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎉 ESP32 Debug方法最终修复验证</h1>
        
        <div>
            <button onclick="testAll()">🚀 一键完整测试</button>
            <button onclick="testConnect()">🔌 连接ESP32测试</button>
            <button onclick="clearLog()">🧹 清空日志</button>
        </div>
        
        <div id="log" class="log">
🔥 准备进行最终验证测试...
📋 所有debug方法调用已修复完成
✅ 现在应该完全没有问题了！
        </div>
    </div>

    <script src="downloaders/base-downloader.js"></script>
    <script src="downloaders/esp32/esp32-esptool-js-wrapper.js"></script>

    <script>
        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${icon} ${msg}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('日志已清空，准备新的测试', 'info');
        }

        async function testAll() {
            clearLog();
            log('🚀 开始完整测试流程...', 'info');
            
            try {
                // 1. 实例创建测试
                log('📝 步骤1: 测试实例创建', 'info');
                const downloader = new ESP32EsptoolJSWrapper(null, {
                    log: (msg) => log(`[DEBUG] ${msg}`, 'info')
                });
                log('✅ ESP32EsptoolJSWrapper 实例创建成功', 'success');
                
                // 2. 方法存在性测试
                log('📝 步骤2: 检查关键方法存在性', 'info');
                const methods = ['debugLog', 'info', 'error', 'write', 'connect', 'sync', 'readReg'];
                let allMethodsExist = true;
                
                methods.forEach(method => {
                    if (typeof downloader[method] === 'function') {
                        log(`✅ ${method} 方法存在`, 'success');
                    } else {
                        log(`❌ ${method} 方法不存在`, 'error');
                        allMethodsExist = false;
                    }
                });
                
                if (!allMethodsExist) {
                    throw new Error('部分方法不存在');
                }
                
                // 3. 方法调用测试
                log('📝 步骤3: 测试方法调用', 'info');
                downloader.debugLog('这是debugLog方法测试');
                downloader.info('这是info方法测试');
                downloader.error('这是error方法测试');
                downloader.write('这是write方法测试');
                log('✅ 所有方法调用测试通过', 'success');
                
                // 4. ROM对象测试
                log('📝 步骤4: 测试ROM对象创建', 'info');
                const rom = downloader.createSimplifiedROM('ESP32', 0x00f01d83);
                if (rom && typeof rom.readEfuse === 'function') {
                    log('✅ ROM对象创建成功，方法完整', 'success');
                } else {
                    throw new Error('ROM对象创建失败');
                }
                
                // 5. 终端接口测试
                log('📝 步骤5: 测试终端接口', 'info');
                const terminal = downloader.createTerminalInterface();
                if (terminal && typeof terminal.write === 'function') {
                    terminal.write('终端接口测试消息');
                    log('✅ 终端接口测试通过', 'success');
                } else {
                    throw new Error('终端接口创建失败');
                }
                
                log('🎉 完整测试流程全部通过！', 'success');
                log('🔥 debug方法冲突问题已彻底解决！', 'success');
                
            } catch (error) {
                log(`❌ 测试失败: ${error.message}`, 'error');
                console.error('测试详细错误:', error);
            }
        }

        async function testConnect() {
            if (!navigator.serial) {
                log('❌ 浏览器不支持Web Serial API', 'error');
                return;
            }

            try {
                log('🔌 开始ESP32连接测试...', 'info');
                
                const port = await navigator.serial.requestPort();
                log('✅ 串口选择成功', 'success');
                
                const downloader = new ESP32EsptoolJSWrapper(port, {
                    log: (msg) => log(`[CALLBACK] ${msg}`, 'info'),
                    debug: (msg) => log(`[DEBUG] ${msg}`, 'info')
                });
                
                log('🚀 开始连接ESP32设备...', 'info');
                await downloader.connect();
                
                log('🎉 ESP32连接测试成功！', 'success');
                log('✅ 所有debug方法工作正常！', 'success');
                
                // 测试一些基本功能
                if (downloader.detectedChip) {
                    log(`📋 检测到芯片: ${downloader.detectedChip}`, 'info');
                    
                    const chipInfo = downloader.getChipInfo();
                    log(`📋 芯片信息: ${JSON.stringify(chipInfo)}`, 'info');
                }
                
            } catch (error) {
                log(`❌ ESP32连接测试失败: ${error.message}`, 'error');
                log('💡 提示: 请确保ESP32已连接并进入下载模式', 'info');
                console.error('连接详细错误:', error);
            }
        }

        // 页面加载时显示状态
        window.onload = function() {
            if (!navigator.serial) {
                log('❌ 浏览器不支持 Web Serial API', 'error');
                log('💡 请使用 Chrome、Edge 等支持的浏览器', 'info');
            } else {
                log('✅ 浏览器支持 Web Serial API', 'success');
                log('🎯 可以开始测试了！', 'info');
            }
        };
    </script>
</body>
</html> 