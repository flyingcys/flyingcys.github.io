<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T5下载器改进功能验证</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .stats-table th, .stats-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .stats-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .flash-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: white;
        }
        .flash-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            font-family: monospace;
            font-size: 12px;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 T5下载器改进功能验证</h1>
        <div class="info test-result">
            <strong>验证目标：</strong>确保JS版本T5下载器与Python版本功能完全一致
        </div>

        <!-- 模块加载验证 -->
        <div class="test-section">
            <h2>📦 1. 模块加载验证</h2>
            <p>验证所有核心模块是否正确加载和初始化</p>
            <button onclick="testModuleLoading()">开始测试</button>
            <div id="moduleLoadingResult"></div>
        </div>

        <!-- Flash配置验证 -->
        <div class="test-section">
            <h2>💾 2. Flash配置完整性验证</h2>
            <p>验证是否支持39种Flash型号（与Python版本一致）</p>
            <button onclick="testFlashConfig()">开始测试</button>
            <div id="flashConfigResult"></div>
            <div id="flashList" class="flash-list" style="display:none;"></div>
        </div>

        <!-- 协议系统验证 -->
        <div class="test-section">
            <h2>🔗 3. 协议系统验证</h2>
            <p>验证21个T5协议类是否正确实现</p>
            <button onclick="testProtocols()">开始测试</button>
            <div id="protocolResult"></div>
        </div>

        <!-- 智能擦除策略验证 -->
        <div class="test-section">
            <h2>🧹 4. 智能擦除策略验证</h2>
            <p>验证64K/32K/4K自适应擦除算法</p>
            <button onclick="testEraseStrategy()">开始测试</button>
            <div id="eraseStrategyResult"></div>
        </div>

        <!-- 地址对齐处理验证 -->
        <div class="test-section">
            <h2>📍 5. 地址对齐处理验证</h2>
            <p>验证任意地址写入的对齐处理功能</p>
            <button onclick="testAddressAlignment()">开始测试</button>
            <div id="addressAlignmentResult"></div>
        </div>

        <!-- 综合功能验证 -->
        <div class="test-section">
            <h2>🎯 6. 综合功能验证</h2>
            <p>运行所有测试，生成完整的验证报告</p>
            <button onclick="runAllTests()" id="runAllBtn">运行所有测试</button>
            <div id="comprehensiveResult"></div>
        </div>
    </div>

    <!-- 加载所有必需的模块 -->
    <script src="downloaders/protocols/base-protocol.js"></script>
    <script src="downloaders/protocols/t5-protocols.js"></script>
    <script src="downloaders/configs/flash-config-base.js"></script>
    <script src="downloaders/configs/t5-flash-config.js"></script>
    <script src="downloaders/core/erase-strategy.js"></script>
    <script src="downloaders/core/write-strategy.js"></script>
    <script src="downloaders/core/crc-checker.js"></script>
    <script src="downloaders/utils/data-utils.js"></script>
    <script src="downloaders/utils/retry-utils.js"></script>
    <script src="downloaders/base-downloader.js"></script>

    <script>
        // 全局变量
        let testResults = {};
        let totalTests = 0;
        let passedTests = 0;

        // 辅助函数
        function logResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            element.appendChild(div);
        }

        function clearResults(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // 测试1: 模块加载验证
        function testModuleLoading() {
            clearResults('moduleLoadingResult');
            logResult('moduleLoadingResult', '🔄 开始模块加载验证...', 'info');
            
            const modules = [
                { name: 'BaseProtocol', check: () => typeof BaseProtocol !== 'undefined' },
                { name: 'BaseBootRomProtocol', check: () => typeof BaseBootRomProtocol !== 'undefined' },
                { name: 'BaseBootRomFlashProtocol', check: () => typeof BaseBootRomFlashProtocol !== 'undefined' },
                { name: 'T5FlashConfig', check: () => typeof T5FlashConfig !== 'undefined' },
                { name: 'T5EraseStrategy', check: () => typeof T5EraseStrategy !== 'undefined' },
                { name: 'T5WriteStrategy', check: () => typeof T5WriteStrategy !== 'undefined' },
                { name: 'LinkCheckProtocol', check: () => typeof LinkCheckProtocol !== 'undefined' },
                { name: 'GetChipIdProtocol', check: () => typeof GetChipIdProtocol !== 'undefined' },
                { name: 'FlashCustomEraseProtocol', check: () => typeof FlashCustomEraseProtocol !== 'undefined' }
            ];
            
            let passed = 0;
            modules.forEach(module => {
                try {
                    if (module.check()) {
                        logResult('moduleLoadingResult', `✅ ${module.name} 加载成功`, 'success');
                        passed++;
                    } else {
                        logResult('moduleLoadingResult', `❌ ${module.name} 加载失败`, 'error');
                    }
                } catch (error) {
                    logResult('moduleLoadingResult', `❌ ${module.name} 检查异常: ${error.message}`, 'error');
                }
            });
            
            const success = passed === modules.length;
            testResults.moduleLoading = success;
            totalTests++;
            if (success) passedTests++;
            
            logResult('moduleLoadingResult', 
                `📊 模块加载测试完成: ${passed}/${modules.length} 通过 ${success ? '✅' : '❌'}`, 
                success ? 'success' : 'error');
        }

        // 测试2: Flash配置验证
        function testFlashConfig() {
            clearResults('flashConfigResult');
            logResult('flashConfigResult', '🔄 开始Flash配置验证...', 'info');
            
            try {
                const flashConfig = new T5FlashConfig();
                const supportedFlash = flashConfig.getSupportedFlashList();
                
                // 验证Flash数量
                const expectedCount = 39;
                const actualCount = supportedFlash.length;
                
                if (actualCount === expectedCount) {
                    logResult('flashConfigResult', `✅ Flash型号数量正确: ${actualCount}/39`, 'success');
                } else {
                    logResult('flashConfigResult', `❌ Flash型号数量错误: ${actualCount}/39`, 'error');
                }
                
                // 验证关键Flash型号
                const keyFlashIds = [
                    0x00134051, // MD25D40D
                    0x001340c8, // GD25Q41B
                    0x001565c8, // GD25WQ16E (之前缺失)
                    0x00124485, // PY25D22U (之前缺失)
                    0x001260b3  // UC25HQ20
                ];
                
                let keyFlashFound = 0;
                keyFlashIds.forEach(flashId => {
                    const found = supportedFlash.find(flash => 
                        parseInt(flash.flashId, 16) === flashId);
                    if (found) {
                        logResult('flashConfigResult', 
                            `✅ 关键Flash型号存在: ${found.name} (${found.flashId})`, 'success');
                        keyFlashFound++;
                    } else {
                        logResult('flashConfigResult', 
                            `❌ 关键Flash型号缺失: 0x${flashId.toString(16)}`, 'error');
                    }
                });
                
                // 显示完整Flash列表
                const flashListElement = document.getElementById('flashList');
                flashListElement.style.display = 'block';
                flashListElement.innerHTML = '<h4>支持的Flash型号列表:</h4>';
                
                supportedFlash.forEach(flash => {
                    const div = document.createElement('div');
                    div.className = 'flash-item';
                    div.textContent = `${flash.flashId} | ${flash.manufacturer} ${flash.name} | ${flash.sizeBytes/1024/1024}MB`;
                    flashListElement.appendChild(div);
                });
                
                const success = actualCount === expectedCount && keyFlashFound === keyFlashIds.length;
                testResults.flashConfig = success;
                totalTests++;
                if (success) passedTests++;
                
                logResult('flashConfigResult', 
                    `📊 Flash配置测试完成 ${success ? '✅' : '❌'}`, 
                    success ? 'success' : 'error');
                    
            } catch (error) {
                logResult('flashConfigResult', `❌ Flash配置测试异常: ${error.message}`, 'error');
                testResults.flashConfig = false;
                totalTests++;
            }
        }

        // 测试3: 协议系统验证
        function testProtocols() {
            clearResults('protocolResult');
            logResult('protocolResult', '🔄 开始协议系统验证...', 'info');
            
            const protocols = [
                'LinkCheckProtocol', 'GetChipIdProtocol', 'GetFlashMidProtocol',
                'SetBaudrateProtocol', 'FlashReadSRProtocol', 'FlashWriteSRProtocol',
                'FlashErase4kProtocol', 'FlashErase4kExtProtocol', 'FlashCustomEraseProtocol',
                'FlashRead4kProtocol', 'FlashRead4kExtProtocol', 'FlashWrite4kProtocol',
                'FlashWrite4kExtProtocol', 'CheckCrcProtocol', 'CheckCrcExtProtocol',
                'RebootProtocol', 'StayRomProtocol', 'FlashEraseAllProtocol',
                'GetBootVersionProtocol', 'ResetProtocol', 'WriteRegProtocol'
            ];
            
            let protocolsPassed = 0;
            protocols.forEach(protocolName => {
                try {
                    if (typeof window[protocolName] !== 'undefined') {
                        // 尝试创建协议实例
                        const instance = new window[protocolName]();
                        if (instance && typeof instance.cmd === 'function') {
                            logResult('protocolResult', `✅ ${protocolName} 正常`, 'success');
                            protocolsPassed++;
                        } else {
                            logResult('protocolResult', `❌ ${protocolName} 方法缺失`, 'error');
                        }
                    } else {
                        logResult('protocolResult', `❌ ${protocolName} 未定义`, 'error');
                    }
                } catch (error) {
                    logResult('protocolResult', `❌ ${protocolName} 创建失败: ${error.message}`, 'error');
                }
            });
            
            const success = protocolsPassed === protocols.length;
            testResults.protocols = success;
            totalTests++;
            if (success) passedTests++;
            
            logResult('protocolResult', 
                `📊 协议系统测试完成: ${protocolsPassed}/${protocols.length} 通过 ${success ? '✅' : '❌'}`, 
                success ? 'success' : 'error');
        }

        // 测试4: 智能擦除策略验证
        function testEraseStrategy() {
            clearResults('eraseStrategyResult');
            logResult('eraseStrategyResult', '🔄 开始智能擦除策略验证...', 'info');
            
            try {
                // 创建模拟的串口处理器和Flash配置
                const mockSerialHandler = {
                    protocols: { flashCustomErase: { executeProtocol: () => Promise.resolve() } },
                    executeProtocol: () => Promise.resolve()
                };
                
                const mockFlashConfig = {
                    flashSize: 4 * 1024 * 1024, // 4MB
                    isInitialized: () => true
                };
                
                const eraseStrategy = new T5EraseStrategy(mockSerialHandler, mockFlashConfig, true);
                
                // 测试擦除范围计算
                const testCases = [
                    { startAddr: 0x0000, dataLength: 0x1000, expectedSize: 0x1000 },
                    { startAddr: 0x0000, dataLength: 0x10000, expectedSize: 0x10000 },
                    { startAddr: 0x1234, dataLength: 0x2000, expectedSize: 0x2000 }
                ];
                
                let casesPassed = 0;
                testCases.forEach((testCase, index) => {
                    const result = eraseStrategy.calculateEraseRange(testCase.startAddr, testCase.dataLength);
                    if (result.eraseSize === testCase.expectedSize) {
                        logResult('eraseStrategyResult', 
                            `✅ 擦除范围计算测试${index + 1}: 0x${result.eraseSize.toString(16)} (期望: 0x${testCase.expectedSize.toString(16)})`, 
                            'success');
                        casesPassed++;
                    } else {
                        logResult('eraseStrategyResult', 
                            `❌ 擦除范围计算测试${index + 1}: 0x${result.eraseSize.toString(16)} (期望: 0x${testCase.expectedSize.toString(16)})`, 
                            'error');
                    }
                });
                
                // 测试擦除命令选择
                const normalCmd = eraseStrategy.getEraseCommand('sector4K');
                const blockCmd = eraseStrategy.getEraseCommand('block64K');
                
                if (normalCmd === 0x20 && blockCmd === 0xd8) {
                    logResult('eraseStrategyResult', '✅ 擦除命令选择正确 (4K:0x20, 64K:0xd8)', 'success');
                    casesPassed++;
                } else {
                    logResult('eraseStrategyResult', `❌ 擦除命令选择错误 (4K:0x${normalCmd.toString(16)}, 64K:0x${blockCmd.toString(16)})`, 'error');
                }
                
                const success = casesPassed === testCases.length + 1;
                testResults.eraseStrategy = success;
                totalTests++;
                if (success) passedTests++;
                
                logResult('eraseStrategyResult', 
                    `📊 智能擦除策略测试完成 ${success ? '✅' : '❌'}`, 
                    success ? 'success' : 'error');
                    
            } catch (error) {
                logResult('eraseStrategyResult', `❌ 智能擦除策略测试异常: ${error.message}`, 'error');
                testResults.eraseStrategy = false;
                totalTests++;
            }
        }

        // 测试5: 地址对齐处理验证
        function testAddressAlignment() {
            clearResults('addressAlignmentResult');
            logResult('addressAlignmentResult', '🔄 开始地址对齐处理验证...', 'info');
            
            try {
                // 创建模拟的串口处理器和Flash配置
                const mockSerialHandler = {
                    protocols: { 
                        flashRead4k: { getReadContent: (data) => new Uint8Array(4096).fill(0xff) },
                        flashWrite4k: {},
                        checkCrc: {}
                    },
                    executeProtocol: () => Promise.resolve(new Uint8Array(4096).fill(0xff))
                };
                
                const mockFlashConfig = {
                    flashSize: 4 * 1024 * 1024,
                    isInitialized: () => true
                };
                
                const writeStrategy = new T5WriteStrategy(mockSerialHandler, mockFlashConfig, true);
                
                // 测试地址对齐算法
                const testCases = [
                    { addr: 0x1234, expected: { sectorAddr: 0x1000, offset: 0x234 } },
                    { addr: 0x5678, expected: { sectorAddr: 0x5000, offset: 0x678 } },
                    { addr: 0x0000, expected: { sectorAddr: 0x0000, offset: 0x000 } }
                ];
                
                let casesPassed = 0;
                testCases.forEach((testCase, index) => {
                    const sectorAddr = Math.floor(testCase.addr / 0x1000) * 0x1000;
                    const offset = testCase.addr & 0xfff;
                    
                    if (sectorAddr === testCase.expected.sectorAddr && offset === testCase.expected.offset) {
                        logResult('addressAlignmentResult', 
                            `✅ 地址对齐计算测试${index + 1}: 0x${testCase.addr.toString(16)} → 扇区:0x${sectorAddr.toString(16)}, 偏移:0x${offset.toString(16)}`, 
                            'success');
                        casesPassed++;
                    } else {
                        logResult('addressAlignmentResult', 
                            `❌ 地址对齐计算测试${index + 1}: 计算错误`, 'error');
                    }
                });
                
                // 测试0xFF检查
                const allFF = new Uint8Array(100).fill(0xff);
                const notAllFF = new Uint8Array(100).fill(0xff);
                notAllFF[50] = 0x00;
                
                if (writeStrategy.isBufferAll0xFF(allFF) && !writeStrategy.isBufferAll0xFF(notAllFF)) {
                    logResult('addressAlignmentResult', '✅ 0xFF检查功能正常', 'success');
                    casesPassed++;
                } else {
                    logResult('addressAlignmentResult', '❌ 0xFF检查功能异常', 'error');
                }
                
                const success = casesPassed === testCases.length + 1;
                testResults.addressAlignment = success;
                totalTests++;
                if (success) passedTests++;
                
                logResult('addressAlignmentResult', 
                    `📊 地址对齐处理测试完成 ${success ? '✅' : '❌'}`, 
                    success ? 'success' : 'error');
                    
            } catch (error) {
                logResult('addressAlignmentResult', `❌ 地址对齐处理测试异常: ${error.message}`, 'error');
                testResults.addressAlignment = false;
                totalTests++;
            }
        }

        // 运行所有测试
        async function runAllTests() {
            const button = document.getElementById('runAllBtn');
            button.disabled = true;
            button.textContent = '测试进行中...';
            
            clearResults('comprehensiveResult');
            logResult('comprehensiveResult', '🚀 开始综合功能验证...', 'info');
            
            // 重置统计
            testResults = {};
            totalTests = 0;
            passedTests = 0;
            
            // 依次运行所有测试
            testModuleLoading();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testFlashConfig();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testProtocols();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testEraseStrategy();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testAddressAlignment();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 生成综合报告
            const passRate = totalTests > 0 ? (passedTests / totalTests * 100).toFixed(1) : 0;
            const overallSuccess = passedTests === totalTests;
            
            logResult('comprehensiveResult', `📊 测试完成统计: ${passedTests}/${totalTests} 通过 (${passRate}%)`, 'info');
            
            if (overallSuccess) {
                logResult('comprehensiveResult', 
                    '🎉 所有测试通过！JS版本T5下载器已达到Python版本功能水平', 'success');
                logResult('comprehensiveResult', 
                    '✅ 功能完整性: 智能擦除策略、地址对齐处理、39种Flash支持', 'success');
                logResult('comprehensiveResult', 
                    '✅ 协议兼容性: 21个协议100%兼容Python版本', 'success');
                logResult('comprehensiveResult', 
                    '✅ 架构优化: 模块化设计，便于维护和扩展', 'success');
            } else {
                logResult('comprehensiveResult', 
                    '❌ 部分测试失败，请检查具体错误信息', 'error');
            }
            
            // 生成详细报告
            const reportHTML = generateDetailedReport();
            logResult('comprehensiveResult', reportHTML, 'info');
            
            button.disabled = false;
            button.textContent = '运行所有测试';
        }

        // 生成详细报告
        function generateDetailedReport() {
            const timestamp = new Date().toLocaleString('zh-CN');
            return `
                <pre>
=== T5下载器改进验证报告 ===
验证时间: ${timestamp}
验证环境: ${navigator.userAgent}

测试结果概览:
✓ 模块加载验证: ${testResults.moduleLoading ? 'PASS' : 'FAIL'}
✓ Flash配置验证: ${testResults.flashConfig ? 'PASS' : 'FAIL'}  
✓ 协议系统验证: ${testResults.protocols ? 'PASS' : 'FAIL'}
✓ 智能擦除策略: ${testResults.eraseStrategy ? 'PASS' : 'FAIL'}
✓ 地址对齐处理: ${testResults.addressAlignment ? 'PASS' : 'FAIL'}

总体评估: ${passedTests}/${totalTests} 通过 (${totalTests > 0 ? (passedTests/totalTests*100).toFixed(1) : 0}%)

改进成果确认:
${passedTests === totalTests ? '🎉' : '❌'} JS版本已达到Python版本功能水平
${testResults.eraseStrategy ? '✅' : '❌'} 智能擦除策略 (4K/32K/64K自适应)
${testResults.addressAlignment ? '✅' : '❌'} 地址对齐处理 (任意地址写入)
${testResults.flashConfig ? '✅' : '❌'} Flash配置完整 (39种型号支持)
${testResults.protocols ? '✅' : '❌'} 协议系统完善 (21个协议兼容)
${testResults.moduleLoading ? '✅' : '❌'} 模块化架构 (清晰职责分离)

建议: ${passedTests === totalTests ? 
    '所有功能验证通过，可以投入生产使用' : 
    '存在功能问题，建议检查失败的测试项目'}
                </pre>
            `;
        }

        // 页面加载完成后显示欢迎信息
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 T5下载器改进功能验证工具已加载');
            console.log('💡 点击各个测试按钮验证改进功能');
            console.log('📊 运行"运行所有测试"获取完整验证报告');
        });
    </script>
</body>
</html>