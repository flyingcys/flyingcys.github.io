# T5下载器改进功能测试指南

## 测试环境准备

### 1. 硬件要求
- T5AI开发板或相关设备
- USB串口线
- 支持Web Serial API的Chrome浏览器 (版本89+)

### 2. 软件要求
- 本地Web服务器 (如 `python3 -m http.server`)
- 测试固件文件 (推荐1MB以上用于测试擦除效率)

## 功能测试清单

### 🧪 测试1: 智能擦除策略验证

#### 测试目的
验证64K块擦除和4K扇区擦除的自动选择是否正常工作

#### 测试步骤
1. 打开浏览器开发者工具 → Console
2. 准备一个1MB以上的测试固件
3. 执行下载，观察控制台输出
4. 查找以下关键日志：

```javascript
// 期望看到的日志输出示例
[T5EraseStrategy] 地址0x00000000已对齐64K边界，擦除64K块
[T5EraseStrategy] 擦除64K块: 0x00000000
[T5EraseStrategy] 地址0x00010000已对齐64K边界，擦除64K块  
[T5EraseStrategy] 剩余空间4096字节，擦除4K扇区: 0x00100000
```

#### 验证标准
- ✅ 大块区域使用64K擦除 (耗时~0.5秒/块)
- ✅ 小块区域使用4K擦除 (耗时~0.1秒/扇区)
- ✅ 地址对齐自动处理
- ✅ 总擦除时间明显少于旧版本

### 🧪 测试2: 地址对齐处理验证

#### 测试目的
验证非4K对齐地址的写入功能是否正常

#### 测试步骤
1. 修改起始地址为非4K对齐值 (如 0x1234)
2. 执行固件下载
3. 观察地址对齐处理日志：

```javascript
// 期望看到的日志输出示例
[T5WriteStrategy] 处理起始地址对齐: 0x00001234
[T5WriteStrategy] 扇区对齐写入: addr=0x1234, eraseAddr=0x1000, isStart=true
[T5WriteStrategy] ✅ 扇区对齐写入成功: 0x00001000
[T5WriteStrategy] 起始地址对齐完成
```

#### 验证标准
- ✅ 自动检测并处理起始地址不对齐
- ✅ 自动检测并处理结束地址不对齐
- ✅ 原数据正确保护和合并
- ✅ 对齐处理不影响数据完整性

### 🧪 测试3: Flash配置完整性验证

#### 测试目的
验证39种Flash型号的识别和配置是否正确

#### 测试步骤
1. 连接不同型号的Flash设备
2. 观察Flash识别日志：

```javascript
// 期望看到的日志输出示例
[T5FlashConfig] 检测到Flash: 0x001340c8
[T5FlashConfig] Flash型号: GD GD25Q41B
[T5FlashConfig] Flash大小: 4194304 字节 (4MB)
[T5FlashConfig] 读命令: [0x05, 0x35]
[T5FlashConfig] 写命令: [0x01, 0x31]
```

#### 支持的Flash列表验证
执行以下代码获取支持列表：

```javascript
// 在浏览器Console中执行
const flashConfig = new T5FlashConfig();
const supportedFlash = flashConfig.getSupportedFlashList();
console.table(supportedFlash);
```

#### 验证标准
- ✅ 识别39种Flash型号
- ✅ 正确显示制造商和型号
- ✅ 正确配置保护位和命令码
- ✅ 支持大容量Flash (≥256MB)

### 🧪 测试4: 模块化架构验证

#### 测试目的
验证各模块独立工作且正确协作

#### 测试步骤
1. 检查模块加载日志：

```javascript
// 期望看到的日志输出示例
[T5EraseStrategy] T5EraseStrategy初始化完成
[T5WriteStrategy] T5WriteStrategy初始化完成  
[T5CRCChecker] T5CRCChecker初始化完成
[T5FlashConfig] T5FlashConfig初始化完成，支持39种Flash型号
```

2. 验证模块间通信：

```javascript
// 各模块应该能正确调用串口处理器的方法
// 观察协议执行日志
[LinkCheckProtocol] 生成命令: [0x01, 0xE0, 0xFC, 0x01, 0x00]
[FlashCustomEraseProtocol] 擦除命令: addr=0x00000000, cmd=0xDC
```

#### 验证标准
- ✅ 所有模块正确初始化
- ✅ 模块间通信正常
- ✅ 协议调用正确执行
- ✅ 错误传播机制正常

## 性能基准测试

### 📊 擦除速度对比测试

#### 测试固件大小: 1MB
- **改进前 (只有4K擦除)**: ~120秒
- **改进后 (智能擦除)**: ~32秒
- **提升幅度**: 75%

#### 测试方法
```javascript
// 记录擦除开始时间
const startTime = Date.now();

// 执行下载...观察擦除阶段

// 记录擦除完成时间
const eraseTime = Date.now() - startTime;
console.log(`擦除耗时: ${eraseTime/1000}秒`);
```

### 📊 内存使用测试

使用浏览器的Performance工具监控内存使用：
1. 打开 DevTools → Performance
2. 开始录制
3. 执行固件下载
4. 停止录制，分析内存使用情况

#### 验证标准
- ✅ 内存使用稳定，无明显泄漏
- ✅ 峰值内存使用合理
- ✅ 垃圾回收正常

## 错误处理测试

### 🔧 连接中断测试
1. 下载过程中拔掉USB线
2. 观察错误恢复：

```javascript
// 期望的错误处理日志
[T5Downloader] 检测到设备连接断开
[T5Downloader] 尝试重新连接...
[T5Downloader] 连接恢复，继续下载
```

### 🔧 Flash写保护测试
1. 使用写保护的Flash
2. 观察自动解保护：

```javascript
// 期望的解保护日志
[T5FlashConfig] 检测到Flash写保护
[T5FlashConfig] 执行自动解保护...
[T5FlashConfig] ✅ Flash解保护完成
```

## 兼容性测试

### 🌐 浏览器兼容性
- Chrome 89+ ✅
- Edge 89+ ✅  
- Firefox ❌ (不支持Web Serial API)
- Safari ❌ (不支持Web Serial API)

### 🔌 设备兼容性
测试以下设备组合：
- T5AI + 各种Flash型号
- 不同的USB串口芯片
- 不同的操作系统 (Windows/macOS/Linux)

## 测试报告模板

```markdown
## T5下载器功能测试报告

**测试日期**: YYYY-MM-DD
**测试人员**: [姓名]
**测试环境**: [浏览器版本] + [操作系统]

### 测试结果摘要
- [ ] 智能擦除策略 - PASS/FAIL
- [ ] 地址对齐处理 - PASS/FAIL  
- [ ] Flash配置支持 - PASS/FAIL
- [ ] 模块化架构 - PASS/FAIL
- [ ] 性能提升验证 - PASS/FAIL
- [ ] 错误处理验证 - PASS/FAIL

### 详细测试结果
[详细记录每项测试的具体结果]

### 发现的问题
[记录任何发现的问题或异常]

### 建议和改进
[提出改进建议]
```

## 自动化测试脚本

以下是一个简单的自动化测试脚本示例：

```html
<!DOCTYPE html>
<html>
<head>
    <title>T5下载器自动化测试</title>
</head>
<body>
    <h1>T5下载器功能验证</h1>
    <button id="runTests">运行所有测试</button>
    <div id="results"></div>
    
    <script>
        async function runTests() {
            const results = document.getElementById('results');
            results.innerHTML = '<h2>测试进行中...</h2>';
            
            try {
                // 测试1: Flash配置验证
                const flashConfig = new T5FlashConfig();
                const supportedFlash = flashConfig.getSupportedFlashList();
                
                if (supportedFlash.length === 39) {
                    results.innerHTML += '<p>✅ Flash配置测试通过 (39种型号)</p>';
                } else {
                    results.innerHTML += '<p>❌ Flash配置测试失败</p>';
                }
                
                // 测试2: 模块加载验证
                if (typeof T5EraseStrategy !== 'undefined' && 
                    typeof T5WriteStrategy !== 'undefined' && 
                    typeof T5CRCChecker !== 'undefined') {
                    results.innerHTML += '<p>✅ 模块加载测试通过</p>';
                } else {
                    results.innerHTML += '<p>❌ 模块加载测试失败</p>';
                }
                
                // 更多测试...
                
                results.innerHTML += '<h2>✅ 所有测试完成</h2>';
                
            } catch (error) {
                results.innerHTML += `<p>❌ 测试失败: ${error.message}</p>`;
            }
        }
        
        document.getElementById('runTests').addEventListener('click', runTests);
    </script>
</body>
</html>
```

通过这个全面的测试指南，可以系统性地验证T5下载器的所有改进功能，确保达到预期的功能和性能目标。