<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ğŸ¯ ç»ˆæä¿®å¤éªŒè¯</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            color: white;
        }
        .container {
            background: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .log { 
            background: #000; 
            color: #0f0; 
            padding: 20px; 
            height: 500px; 
            overflow-y: auto; 
            font-family: monospace; 
            border: 2px solid #0f0;
            border-radius: 10px;
        }
        button { 
            padding: 15px 30px; 
            margin: 10px; 
            background: #28a745; 
            color: white; 
            border: none; 
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }
        button:hover { background: #218838; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        h1 { text-align: center; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ ç»ˆæDebugä¿®å¤éªŒè¯</h1>
        
        <div style="text-align: center; margin-bottom: 30px;">
            <button onclick="testAllSystems()">ğŸš€ ä¸€é”®éªŒè¯å…¨éƒ¨ç³»ç»Ÿ</button>
            <button onclick="testRealConnection()">ğŸ”Œ çœŸå®è¿æ¥æµ‹è¯•</button>
            <button onclick="clearLog()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div id="log" class="log">
ğŸ¯ å‡†å¤‡è¿›è¡Œç»ˆæéªŒè¯æµ‹è¯•...
âœ… å·²ä¿®å¤ESP32SeriesDownloaderä¸­çš„æ‰€æœ‰debugå†²çª
âœ… å·²ä¿®å¤ESP32SimpleDownloaderä¸­çš„æ‰€æœ‰debugå†²çª
âœ… å·²ä¿®å¤terminalæ¥å£é—®é¢˜
âœ… å·²ä¿®å¤æ‰€æœ‰ROMå¯¹è±¡è°ƒç”¨
ğŸ”¥ ç°åœ¨æ‰€æœ‰é¡µé¢éƒ½åº”è¯¥èƒ½æ­£å¸¸å·¥ä½œäº†ï¼
        </div>
    </div>

    <script src="downloaders/base-downloader.js"></script>
    <script src="downloaders/esp32-esptool-js-wrapper.js"></script>

    <script>
        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'ğŸ”';
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${icon} ${msg}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©ºï¼Œå‡†å¤‡æ–°çš„æµ‹è¯•', 'info');
        }

        async function testAllSystems() {
            clearLog();
            log('ğŸ¯ å¼€å§‹ç»ˆæç³»ç»ŸéªŒè¯...', 'info');
            
            try {
                // 1. ESP32SeriesDownloaderæµ‹è¯•
                log('ğŸ“ æ­¥éª¤1: æµ‹è¯•ESP32SeriesDownloader', 'info');
                const esp32Series = new ESP32SeriesDownloader(null, {
                    log: (msg) => log(`[ESP32Series] ${msg}`, 'info')
                });
                
                // æµ‹è¯•æ‰€æœ‰å¯èƒ½çš„æ–¹æ³•è°ƒç”¨
                esp32Series.debugLog('ESP32SeriesDownloader debugLogæµ‹è¯•');
                esp32Series.info('ESP32SeriesDownloader infoæµ‹è¯•');
                esp32Series.error('ESP32SeriesDownloader erroræµ‹è¯•');
                esp32Series.write('ESP32SeriesDownloader writeæµ‹è¯•');
                
                // æµ‹è¯•ROMå¯¹è±¡åˆ›å»º
                const rom = esp32Series.createSimplifiedROM('ESP32', 0x00f01d83);
                log('ROMå¯¹è±¡åˆ›å»ºæˆåŠŸ', 'success');
                
                // æµ‹è¯•terminalæ¥å£
                const terminal = esp32Series.createTerminalInterface();
                terminal.write('Terminal writeæµ‹è¯•');
                terminal.writeLine('Terminal writeLineæµ‹è¯•');
                
                log('âœ… ESP32SeriesDownloader å…¨éƒ¨æµ‹è¯•é€šè¿‡', 'success');
                
                // 2. ESP32SimpleDownloaderæµ‹è¯•
                log('ğŸ“ æ­¥éª¤2: æµ‹è¯•ESP32SimpleDownloader', 'info');
                const esp32Simple = new ESP32SimpleDownloader(null, { debug: true });
                
                // æµ‹è¯•debugæ–¹æ³•
                esp32Simple.debugLog('ESP32SimpleDownloader debugLogæµ‹è¯•');
                
                log('âœ… ESP32SimpleDownloader å…¨éƒ¨æµ‹è¯•é€šè¿‡', 'success');
                
                // 3. æ•°æ®è½¬æ¢æµ‹è¯•
                log('ğŸ“ æ­¥éª¤3: æµ‹è¯•æ•°æ®è½¬æ¢åŠŸèƒ½', 'info');
                const testInt = 0x12345678;
                const intBytes = esp32Series._intToByteArray(testInt);
                const backInt = esp32Series._byteArrayToInt(intBytes);
                if (testInt === backInt) {
                    log('æ•°æ®è½¬æ¢æµ‹è¯•é€šè¿‡', 'success');
                } else {
                    throw new Error('æ•°æ®è½¬æ¢æµ‹è¯•å¤±è´¥');
                }
                
                // 4. ç»ˆç«¯å’Œè°ƒè¯•ç³»ç»Ÿæµ‹è¯•
                log('ğŸ“ æ­¥éª¤4: æµ‹è¯•ç»ˆç«¯å’Œè°ƒè¯•ç³»ç»Ÿ', 'info');
                esp32Series.debugMethod('debugMethodæµ‹è¯•');
                log('è°ƒè¯•ç³»ç»Ÿæµ‹è¯•é€šè¿‡', 'success');
                
                // 5. èŠ¯ç‰‡ç‰¹æ€§ç³»ç»Ÿæµ‹è¯•  
                log('ğŸ“ æ­¥éª¤5: æµ‹è¯•èŠ¯ç‰‡ç‰¹æ€§ç³»ç»Ÿ', 'info');
                const features = esp32Series.getChipFeatures('ESP32-S3');
                log(`ESP32-S3ç‰¹æ€§: ${features.join(', ')}`, 'info');
                
                log('ğŸ‰ ç»ˆæç³»ç»ŸéªŒè¯å…¨éƒ¨é€šè¿‡ï¼', 'success');
                log('ğŸ”¥ æ‰€æœ‰debugæ–¹æ³•å†²çªé—®é¢˜å·²å½»åº•è§£å†³ï¼', 'success');
                log('âœ… ç°åœ¨æ‰€æœ‰HTMLæµ‹è¯•æ–‡ä»¶éƒ½åº”è¯¥èƒ½æ­£å¸¸å·¥ä½œï¼', 'success');
                
            } catch (error) {
                log(`âŒ ç³»ç»ŸéªŒè¯å¤±è´¥: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
            }
        }

        async function testRealConnection() {
            if (!navigator.serial) {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒWeb Serial API', 'error');
                return;
            }

            try {
                log('ğŸ”Œ å¼€å§‹çœŸå®ESP32è¿æ¥æµ‹è¯•...', 'info');
                
                const port = await navigator.serial.requestPort();
                log('âœ… ä¸²å£é€‰æ‹©æˆåŠŸ', 'success');
                
                // ä½¿ç”¨ä¿®å¤åçš„ESP32SeriesDownloader
                const downloader = new ESP32SeriesDownloader(port, {
                    log: (msg) => log(`[CONNECTION] ${msg}`, 'info'),
                    debug: (msg) => log(`[DEBUG] ${msg}`, 'info'),
                    error: (msg) => log(`[ERROR] ${msg}`, 'error')
                });
                
                log('ğŸš€ å¼€å§‹è¿æ¥ESP32è®¾å¤‡...', 'info');
                await downloader.connect();
                
                log('ğŸ‰ ESP32è¿æ¥æµ‹è¯•æˆåŠŸï¼æ‰€æœ‰debugé—®é¢˜å·²è§£å†³ï¼', 'success');
                
                // æµ‹è¯•èŠ¯ç‰‡ä¿¡æ¯è·å–
                if (downloader.detectedChip) {
                    log(`ğŸ“‹ æ£€æµ‹åˆ°èŠ¯ç‰‡: ${downloader.detectedChip}`, 'info');
                    
                    const chipInfo = downloader.getChipInfo();
                    log(`ğŸ“‹ èŠ¯ç‰‡è¯¦ç»†ä¿¡æ¯:`, 'info');
                    log(`   - ç±»å‹: ${chipInfo.chipName || 'æœªçŸ¥'}`, 'info');
                    log(`   - æè¿°: ${chipInfo.description || 'æœªçŸ¥'}`, 'info');
                    log(`   - MAC: ${chipInfo.macAddress || 'æœªçŸ¥'}`, 'info');
                    log(`   - Flash: ${chipInfo.flashSize || 'æœªçŸ¥'}`, 'info');
                }
                
                log('âœ… è¿æ¥æµ‹è¯•å®Œæˆï¼Œå¯ä»¥æ–­å¼€è¿æ¥äº†', 'success');
                
            } catch (error) {
                log(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                if (error.message.includes('this.debug is not a function')) {
                    log('ğŸš¨ ä»ç„¶å­˜åœ¨debugæ–¹æ³•å†²çªï¼è¯·æ£€æŸ¥ä»£ç ', 'error');
                } else {
                    log('ğŸ’¡ è¿™å¯èƒ½æ˜¯æ­£å¸¸çš„è¿æ¥é”™è¯¯ï¼ˆè®¾å¤‡æœªè¿æ¥ã€æœªè¿›å…¥ä¸‹è½½æ¨¡å¼ç­‰ï¼‰', 'info');
                }
                console.error('è¿æ¥è¯¦ç»†é”™è¯¯:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºçŠ¶æ€
        window.onload = function() {
            if (!navigator.serial) {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒ Web Serial API', 'error');
                log('ğŸ’¡ è¯·ä½¿ç”¨ Chromeã€Edge ç­‰æ”¯æŒçš„æµè§ˆå™¨', 'info');
            } else {
                log('âœ… æµè§ˆå™¨æ”¯æŒ Web Serial API', 'success');
                log('ğŸ¯ ready for ultimate test!', 'info');
            }
        };
    </script>
</body>
</html>